<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>TAP FOXIO</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  /* ===== Original Styles Theke ===== */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }
  
  body {
    -webkit-tap-highlight-color: transparent;
    -webkit-user-drag: none;
  }
  
  html, body {
    height: 100%;
    touch-action: manipulation;
  }
  
  :root {
    --bg:#0d0a1f; 
    --card:rgba(23,19,44,0.9); 
    --primary:#00f2ff;
    --secondary:#ff00f2; 
    --text:#ffffff; 
    --muted:#a0a0a0; 
    --radius:16px;
    --danger:#ff4757;
    --success:#00ff9d;
    --warning:#FFD700;
    --up:#00ff9d;
    --down:#ff4757;
  }
  
  body {
    background:linear-gradient(135deg,#0d0a1f,#1f0a2e,#0d0a1f); 
    display:flex; 
    justify-content:center; 
    color:var(--text);
  }
  
  .app {
    width:100%; 
    height:100%; 
    display:flex; 
    flex-direction:column; 
    background:rgba(13,10,31,0.6); 
    overflow:hidden;
    position: relative;
  }
  
  .top-bar {
    padding:15px; 
    display:flex; 
    justify-content:space-between; 
    align-items:center;
    background: rgba(23,19,44,0.95);
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .profile {
    display:flex; 
    align-items:center; 
    gap:10px;
  }
  
  .profile img {
    width:40px;
    height:40px; 
    border-radius:50%; 
    border:2px solid var(--primary);
  }
  
  .user-info {
    display:flex; 
    flex-direction:column; 
    gap:2px;
  }
  
  .user-info span.username {
    font-weight:600;
    font-size: 14px;
  }
  
  .user-info span.status {
    font-size:0.7rem; 
    color: var(--danger);
    font-weight: bold;
    animation: blink 1.5s infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .user-info span.status.verified {
    color: var(--success);
    animation: none;
  }
  
  .points {
    font-size:1.5rem; 
    font-weight:700; 
    display:flex; 
    align-items:center; 
    gap:12px;
  }
  
  .points img {
    width:40px;
    height:40px;
  }
  
  .points span {
    font-size:15px; 
    font-weight:bold; 
    letter-spacing:0.5px;
  }
  
  .page {
    flex:1; 
    display:none; 
    overflow-y:auto;
    padding-bottom: 70px;
  }
  
  .page.active {
    display:block;
  }
  
  .card {
    background:var(--card); 
    padding:15px; 
    border-radius:12px; 
    margin-bottom:12px; 
    display:flex; 
    justify-content:space-between; 
    align-items:center;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .btn {
    padding:12px 20px; 
    border-radius:10px; 
    border:none; 
    font-weight:600; 
    background:linear-gradient(90deg,var(--secondary),var(--primary)); 
    color:#000; 
    cursor:pointer;
    font-size: 14px;
    transition: all 0.3s;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,242,255,0.3);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-success {
    background: linear-gradient(90deg, #00b09b, #96c93d);
    color: white;
  }

  .btn-primary {
    background: linear-gradient(90deg, #00f2ff, #0077ff);
    color: white;
  }

  .btn-warning {
    background: linear-gradient(90deg, #f7971e, #ffd200);
    color: white;
  }
  
  .nav {
    display:flex; 
    justify-content:space-around; 
    padding:12px 0; 
    background:var(--card); 
    border-top:1px solid rgba(255,255,255,0.1);
    position: fixed;
    bottom: 0;
    width: 100%;
    z-index: 100;
  }
  
  .nav-item {
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    font-size:0.7rem; 
    color:var(--muted); 
    cursor:pointer;
    transition: all 0.3s;
    padding: 5px 10px;
    border-radius: 8px;
  }
  
  .nav-item i {
    font-size:1.4rem; 
    margin-bottom:4px;
  }
  
  .nav-item.active {
    color:var(--primary);
    background: rgba(0,242,255,0.1);
  }

  .nav-item:hover {
    color: var(--primary);
  }
  
  .toast {
    position:fixed; 
    bottom:80px; 
    left:50%; 
    transform:translateX(-50%); 
    background:linear-gradient(90deg, var(--secondary), var(--primary));
    color:#000; 
    padding:12px 18px; 
    border-radius:12px; 
    display:none; 
    z-index:999;
    font-weight: 600;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  
  .balance-card {
    background: linear-gradient(135deg,#7b5cff,#a06bff); 
    color:#000; 
    padding:30px 20px; 
    text-align:center; 
    border-radius:24px; 
    margin: 20px;
    box-shadow:0 4px 15px rgba(0,0,0,0.1);
    border: 2px solid var(--primary);
  }
  
  .balance-card h2 {
    margin:0; 
    font-weight:600; 
    font-size:20px;
  }
  
  .balance {
    font-size:36px; 
    font-weight:700; 
    margin-top:10px;
  }
  
  .section {
    padding:20px;
  }
  
  .asset {
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    padding:14px 10px; 
    border-radius:12px; 
    margin-bottom:10px; 
    background:#f8f8f8; 
    box-shadow:0 2px 5px rgba(0,0,0,0.05); 
    color:#000;
  }
  
  .asset-left {
    display:flex; 
    gap:12px; 
    align-items:center; 
    font-weight:500;
  }
  
  .icon {
    width:42px; 
    height:42px; 
    border-radius:50%; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    overflow:hidden; 
    flex-shrink:0;
  }
  
  .icon img {
    width:100%; 
    height:100%; 
    object-fit:cover;
  }
  
  .btc,.eth,.ltc,.foxio {
    background:#FFFFFF00;
  }
  
  .price {
    text-align:right; 
    font-weight:600; 
    font-size:16px; 
    color:#000;
  }
  
  /* ===== Home Page Leaderboard ===== */
  .home-leaderboard-section {
    background: var(--card);
    border-radius: 12px;
    padding: 15px;
    margin: 15px;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .home-leaderboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .home-leaderboard-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .home-leaderboard-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .home-leaderboard-item {
    display: flex;
    align-items: center;
    padding: 8px 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.05);
    transition: all 0.3s;
    cursor: pointer;
  }

  .home-leaderboard-item:hover {
    background: rgba(255,255,255,0.1);
    transform: translateX(5px);
  }

  .home-leaderboard-rank {
    font-size: 14px;
    font-weight: 700;
    min-width: 30px;
    text-align: center;
  }

  .rank-1 { color: #FFD700; }
  .rank-2 { color: #C0C0C0; }
  .rank-3 { color: #CD7F32; }
  .rank-other { color: var(--muted); }

  .home-leaderboard-user {
    display: flex;
    align-items: center;
    flex: 1;
    gap: 10px;
  }

  .home-leaderboard-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 1px solid var(--primary);
  }

  .home-leaderboard-name {
    font-size: 12px;
    font-weight: 500;
    flex: 1;
  }

  .home-leaderboard-coins {
    font-size: 13px;
    font-weight: 700;
    color: var(--primary);
  }
  
  /* ===== Profile Page ===== */
  .profile-page {
    padding: 20px;
  }

  .profile-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 30px;
    position: relative;
  }

  .profile-pic {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 3px solid var(--primary);
    margin-bottom: 15px;
    box-shadow: 0 0 20px rgba(0,242,255,0.5);
  }

  .profile-name {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 5px;
  }

  .profile-id {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 20px;
  }

  .profile-action-grid {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
  }

  .profile-action-card {
    background: var(--card);
    padding: 15px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid rgba(255,255,255,0.1);
    text-align: center;
    flex: 1;
    justify-content: center;
    min-width: 0;
  }

  .profile-action-card:hover {
    transform: translateY(-3px);
    border-color: var(--primary);
    box-shadow: 0 5px 15px rgba(0,242,255,0.3);
  }

  .profile-action-card i {
    font-size: 20px;
    color: var(--primary);
    min-width: 20px;
  }

  .profile-action-card span {
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 20px;
  }

  .stat-card {
    background: var(--card);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 5px;
  }

  .stat-label {
    font-size: 12px;
    color: var(--muted);
  }
  
  /* ===== Plans Page ===== */
  .plans-page {
    padding: 20px;
  }

  .plans-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 20px;
  }

  .plan-card {
    background: var(--card);
    border-radius: 16px;
    padding: 25px;
    border: 2px solid transparent;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }

  .plan-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .plan-card.basic {
    border-color: var(--primary);
  }

  .plan-card.advance {
    border-color: var(--secondary);
  }

  .plan-card.premium {
    border-color: #FFD700;
  }

  .plan-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: linear-gradient(90deg, var(--secondary), var(--primary));
    color: black;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
  }

  .plan-badge.premium {
    background: linear-gradient(90deg, #FFD700, #FFA500);
  }

  .plan-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 15px;
    color: var(--primary);
  }

  .plan-price {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 20px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .plan-features {
    list-style: none;
    margin-bottom: 25px;
  }

  .plan-features li {
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .plan-features li i {
    color: var(--success);
  }

  .plan-btn {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    font-weight: 700;
  }
  
  /* ===== Deposit Page ===== */
  .deposit-page {
    padding: 20px;
  }

  .deposit-form {
    background: var(--card);
    padding: 25px;
    border-radius: 16px;
    margin-top: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--primary);
  }

  .form-control {
    width: 100%;
    padding: 12px 15px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.1);
    color: white;
    font-size: 14px;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--primary);
  }

  .payment-info {
    background: rgba(0,255,157,0.1);
    border: 1px solid var(--success);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .payment-info h4 {
    color: var(--success);
    margin-bottom: 10px;
  }

  .payment-details {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(0,0,0,0.3);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
  }

  .copy-btn {
    background: var(--primary);
    color: black;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
  }

  .history-list {
    margin-top: 30px;
  }

  .history-item {
    background: var(--card);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 4px solid var(--primary);
  }

  .history-status {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .status-pending {
    background: rgba(255,215,0,0.1);
    color: var(--warning);
  }

  .status-approved {
    background: rgba(0,255,157,0.1);
    color: var(--success);
  }

  .status-rejected {
    background: rgba(255,71,87,0.1);
    color: var(--danger);
  }
  
  /* ===== Tap Page ===== */
  #tapPage .mining-card {
    width:90%; 
    max-width:360px; 
    margin:20px auto; 
    background: rgba(255,255,255,0.9); 
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px); 
    border-radius:12px; 
    padding:15px 20px;
    font-weight:600; 
    color:#000; 
    font-size:16px; 
    text-align:center; 
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  
  .tg-webapp-top-pack {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 90%;
    max-width: 400px;
    margin: 10px auto;
    padding: 8px 12px;
    background: rgba(23,19,44,0.9);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    height: auto;
  }

  .pack-items {
    display: flex;
    align-items: center;
    justify-content: space-around;
    width: 100%;
  }

  .lock-box {
    position: relative;
    width: 70px;
    height: 70px;
    margin: 0 5px;
  }

  .lock-box .menu-btn {
    width: 100%;
    height: 100%;
    font-size: 12px;
    background: linear-gradient(135deg, #00f2ff, #0077ff);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    z-index: 2;
    position: relative;
    color: white;
    font-weight: 600;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: all 0.3s;
    padding: 5px;
  }

  .lock-box .menu-btn img {
    width: 24px;
    height: 24px;
  }

  .lock-box .menu-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,242,255,0.4);
  }

  .lock-box .chain {
    position: absolute;
    top: 50%;
    height: 8px;
    background: repeating-linear-gradient(
      90deg,
      #aaa,
      #aaa 6px,
      #666 6px,
      #666 12px
    );
    transform: translateY(-50%);
    transition: 0.7s ease;
    z-index: 1;
  }

  .lock-box .chain.left {
    left: 0;
    width: 0;
  }

  .lock-box .chain.right {
    right: 0;
    width: 0;
  }

  .lock-box .lock {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-size: 24px;
    transition: 0.4s ease;
    z-index: 3;
    color: var(--warning);
  }

  .lock-box.locked .chain.left,
  .lock-box.locked .chain.right {
    width: 50%;
  }

  .lock-box.locked .lock {
    transform: translate(-50%, -50%) scale(1);
  }

  .lock-box.locked .menu-btn {
    background: #555;
    color: #ccc;
    pointer-events: none;
  }
  
  #tapPage .tap-zone {
    flex:1; 
    display:flex; 
    justify-content:center; 
    align-items:center; 
    position:relative; 
    margin:0;
    min-height: 300px;
  }
  
  #tapPage .tap-btn {
    width:220px; 
    height:220px; 
    border-radius:50%; 
    background:radial-gradient(circle,#00f2ff,#ff00f2); 
    display:flex; 
    justify-content:center; 
    align-items:center; 
    box-shadow:0 0 40px #00f2ff; 
    cursor:pointer; 
    position:relative; 
    overflow:hidden;
    transition: all 0.1s;
  }
  
  #tapPage .tap-btn:active {
    transform: scale(0.95);
    box-shadow:0 0 60px #00f2ff;
  }
  
  #tapPage .tap-btn img {
    width:180px; 
    height:180px; 
    pointer-events:none;
    border-radius: 50%;
  }
  
  #tapPage .tap-animate {
    animation:tapScale .3s;
  }
  
  @keyframes tapScale {
    from { transform:scale(.9); }
    to { transform:scale(1); }
  }
  
  #tapPage .tap-toast {
    position:absolute; 
    color:#00f2ff; 
    font-weight:700; 
    font-size:20px; 
    animation:floatUp .8s forwards; 
    text-shadow:0 0 8px rgba(0,242,255,.8);
    z-index: 10;
  }
  
  @keyframes floatUp {
    0% { opacity:0; transform:translateY(0) scale(.8); }
    20% { opacity:1; }
    100% { opacity:0; transform:translateY(-80px) scale(1.2); }
  }
  
  #tapPage .continue-btn {
    display:none; 
    position:absolute; 
    padding:14px 22px; 
    background:linear-gradient(90deg,#ff00f2,#00f2ff); 
    border:none;
    border-radius:12px; 
    color:#fff;
    font-weight:700; 
    cursor:pointer; 
    animation:bounce 1s infinite; 
    z-index:2;
    font-size: 16px;
  }
  
  @keyframes bounce {
    0%,100% { transform:translateY(0); }
    50% { transform:translateY(-12px); }
  }
  
  #tapPage .energy-container {
    width:90%; 
    max-width:420px; 
    margin:20px auto;
  }
  
  #tapPage .energy-bar-container {
    width:100%; 
    height:14px; 
    margin:10px 0; 
    background:rgba(255,255,255,.15); 
    border-radius:10px; 
    overflow:hidden; 
  }
  
  #tapPage .energy-bar-fill {
    height:100%; 
    width:100%; 
    background: linear-gradient(90deg,#ff00f2,#00f2ff); 
    transition:width 0.3s linear;
    border-radius: 10px;
  }
  
  #tapPage .energy-info {
    display:flex; 
    justify-content:space-between; 
    font-size:0.85rem; 
    color:#fff;
  }
  
  #tapPage .dialog {
    position:fixed; 
    inset:0; 
    background:rgba(0,0,0,.85); 
    display:none; 
    align-items:center; 
    justify-content:center; 
    z-index:999;
  }
  
  #tapPage .dialog-box {
    background:#111; 
    padding:25px; 
    border-radius:14px; 
    width:90%; 
    max-width:320px; 
    text-align:center;
    border: 2px solid var(--primary);
  }
  
  #tapPage .dialog-count {
    font-weight:700; 
    font-size:18px; 
    margin:10px 0;
    color: var(--primary);
  }
  
  #tapPage .dialog-btn {
    padding:12px 24px; 
    border:none; 
    border-radius:12px; 
    background:linear-gradient(90deg,#ff00f2,#00f2ff); 
    color:#fff; 
    font-weight:700; 
    cursor:pointer;
    width: 100%;
    margin-top: 15px;
  }

  /* ===== Play Page ===== */
  .play-page {
    padding: 20px;
    text-align: center;
  }

  .play-container {
    background: var(--card);
    border-radius: 20px;
    padding: 40px 20px;
    margin: 20px;
    border: 2px solid var(--primary);
    box-shadow: 0 10px 30px rgba(0,242,255,0.2);
  }

  .play-icon {
    font-size: 80px;
    color: var(--primary);
    margin-bottom: 20px;
    animation: jump 1s infinite alternate;
  }

  @keyframes jump {
    0% { transform: translateY(0); }
    100% { transform: translateY(-20px); }
  }

  .play-title {
    font-size: 32px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 15px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .play-subtitle {
    font-size: 18px;
    color: var(--muted);
    margin-bottom: 30px;
  }

  .coming-soon {
    display: inline-block;
    padding: 10px 30px;
    background: linear-gradient(90deg, var(--secondary), var(--primary));
    color: black;
    border-radius: 50px;
    font-weight: 700;
    font-size: 22px;
    animation: pulse 1.5s infinite;
  }
  
  /* ===== BUY PAGE ===== */
  .buy-market-page {
    padding: 20px;
    text-align: center;
  }

  .market-header {
    margin-bottom: 30px;
  }

  .market-title {
    font-size: 28px;
    font-weight: 800;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 10px;
  }

  .market-subtitle {
    color: var(--muted);
    font-size: 14px;
  }

  .foxio-rate-card {
    background: var(--card);
    border-radius: 20px;
    padding: 25px;
    margin: 20px auto;
    max-width: 400px;
    border: 2px solid var(--primary);
    box-shadow: 0 10px 30px rgba(0,242,255,0.2);
  }

  .rate-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
  }

  .rate-label {
    font-size: 14px;
    color: var(--muted);
  }

  .rate-value {
    font-size: 36px;
    font-weight: 800;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .rate-change {
    font-size: 16px;
    font-weight: 600;
    padding: 5px 15px;
    border-radius: 20px;
  }

  .rate-change.up {
    background: rgba(0,255,157,0.1);
    color: var(--up);
  }

  .rate-change.down {
    background: rgba(255,71,87,0.1);
    color: var(--down);
  }

  /* ===== Premium Chart Container ===== */
  .premium-chart-container {
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid rgba(255,255,255,0.1);
    position: relative;
    overflow: hidden;
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .chart-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
  }

  .chart-period {
    display: flex;
    gap: 5px;
  }

  .period-btn {
    padding: 5px 10px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 8px;
    color: var(--text);
    font-size: 12px;
    cursor: pointer;
  }

  .period-btn.active {
    background: var(--primary);
    color: #000;
  }

  .chart-wrapper {
    position: relative;
    width: 100%;
    height: 250px;
    overflow: hidden;
    touch-action: pan-x pinch-zoom;
  }

  .chart-scrollable {
    width: 2000px;
    height: 100%;
    position: relative;
    cursor: grab;
    transition: transform 0.3s ease;
  }

  .chart-scrollable:active {
    cursor: grabbing;
  }

  .chart-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .current-price-line {
    position: absolute;
    width: 100%;
    border-top: 2px dashed var(--primary);
    pointer-events: none;
    z-index: 2;
  }

  .price-point {
    position: absolute;
    background: var(--primary);
    width: 8px;
    height: 8px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    z-index: 3;
    box-shadow: 0 0 10px rgba(0,242,255,0.5);
  }

  .price-tooltip {
    position: absolute;
    background: rgba(0,0,0,0.9);
    border: 1px solid var(--primary);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    color: white;
    z-index: 10;
    pointer-events: none;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }

  .tooltip-date {
    color: var(--muted);
    font-size: 10px;
    margin-bottom: 2px;
  }

  .tooltip-price {
    color: var(--primary);
    font-weight: 600;
  }

  .time-indicator {
    position: absolute;
    bottom: 10px;
    left: 0;
    width: 100%;
    text-align: center;
    color: var(--muted);
    font-size: 12px;
    pointer-events: none;
    z-index: 2;
  }

  .chart-footer {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
    font-size: 12px;
    color: var(--muted);
  }

  .chart-stats {
    display: flex;
    gap: 15px;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .chart-stat-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }

  .chart-stat-label {
    font-size: 10px;
    color: var(--muted);
  }

  /* ===== Buy Now Section ===== */
  .buy-now-section {
    margin-top: 30px;
    padding: 20px;
    background: var(--card);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .buy-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .info-label {
    color: var(--muted);
    font-size: 14px;
  }

  .info-value {
    font-weight: 600;
    color: var(--primary);
    font-size: 16px;
  }

  .buy-btn {
    width: 100%;
    padding: 18px;
    font-size: 18px;
    font-weight: 700;
    background: linear-gradient(90deg, var(--secondary), var(--primary));
    border: none;
    border-radius: 15px;
    color: #000;
    cursor: pointer;
    transition: all 0.3s;
  }

  .buy-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,242,255,0.4);
  }

  /* ===== BUY FORM PAGE ===== */
  .buy-form-page {
    padding: 20px;
  }

  .form-header {
    text-align: center;
    margin-bottom: 25px;
  }

  .form-header h2 {
    color: var(--primary);
    margin-bottom: 10px;
  }

  .form-header p {
    color: var(--muted);
  }

  .current-rate-box {
    background: rgba(0,242,255,0.1);
    border-radius: 12px;
    padding: 15px;
    margin: 20px 0;
    border: 1px solid var(--primary);
    text-align: center;
  }

  .current-rate-label {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 5px;
  }

  .current-rate-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
  }

  .buy-form {
    background: var(--card);
    border-radius: 20px;
    padding: 25px;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--primary);
    font-size: 14px;
  }

  .form-input {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    color: white;
    font-size: 16px;
    transition: all 0.3s;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(0,242,255,0.2);
  }

  .form-input::placeholder {
    color: rgba(255,255,255,0.5);
  }

  .input-with-icon {
    position: relative;
  }

  .input-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--primary);
    font-weight: 600;
  }

  .calculation-box {
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    padding: 20px;
    margin: 25px 0;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .calc-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .calc-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .calc-label {
    color: var(--muted);
    font-size: 14px;
  }

  .calc-value {
    font-weight: 600;
    color: var(--text);
    font-size: 16px;
  }

  .calc-total {
    color: var(--primary);
    font-size: 20px;
    font-weight: 700;
  }

  .method-selection {
    margin: 25px 0;
  }

  .method-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 15px;
  }

  .method-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  .method-option {
    background: rgba(255,255,255,0.05);
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 20px 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
  }

  .method-option:hover {
    background: rgba(255,255,255,0.1);
    transform: translateY(-2px);
  }

  .method-option.active {
    border-color: var(--primary);
    background: rgba(0,242,255,0.1);
  }

  .method-icon {
    font-size: 28px;
    margin-bottom: 10px;
    color: var(--primary);
  }

  .method-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 5px;
  }

  .method-fee {
    font-size: 12px;
    color: var(--muted);
  }

  .payment-info-box {
    background: rgba(0,255,157,0.1);
    border: 1px solid var(--success);
    border-radius: 12px;
    padding: 20px;
    margin: 25px 0;
  }

  .payment-info-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    color: var(--success);
  }

  .payment-info-header i {
    font-size: 20px;
  }

  .payment-info-header h4 {
    font-size: 16px;
    font-weight: 600;
  }

  .payment-details {
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    position: relative;
  }

  .payment-number {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    text-align: center;
    margin-bottom: 10px;
    font-family: monospace;
    letter-spacing: 1px;
  }

  .payment-note {
    font-size: 12px;
    color: var(--muted);
    text-align: center;
    line-height: 1.5;
  }

  .copy-btn-container {
    display: flex;
    justify-content: center;
    margin-top: 15px;
  }

  .copy-btn {
    width: 150px;
    padding: 12px;
    background: var(--primary);
    color: #000;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s;
  }

  .copy-btn:hover {
    background: #00e0e0;
    transform: translateY(-2px);
  }

  .copy-btn.copied {
    background: var(--success);
    color: #000;
  }

  .form-actions {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }

  .btn-back {
    flex: 1;
    background: rgba(255,255,255,0.1);
    color: var(--text);
  }

  .btn-buy {
    flex: 2;
    background: linear-gradient(90deg, var(--secondary), var(--primary));
    color: #000;
    font-weight: 700;
    font-size: 16px;
  }

  /* ===== HISTORY PAGE ===== */
  .history-page {
    padding: 20px;
  }

  .history-header {
    text-align: center;
    margin-bottom: 25px;
  }

  .history-header h2 {
    color: var(--primary);
    margin-bottom: 10px;
  }

  .history-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .history-tab {
    padding: 10px 20px;
    background: var(--card);
    border-radius: 50px;
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 600;
    font-size: 14px;
  }

  .history-tab:hover {
    background: rgba(255,255,255,0.1);
  }

  .history-tab.active {
    background: var(--primary);
    color: #000;
    border-color: var(--primary);
  }

  .history-list {
    background: var(--card);
    border-radius: 20px;
    padding: 20px;
    border: 1px solid rgba(255,255,255,0.1);
    min-height: 300px;
  }

  .history-item {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    border-left: 4px solid var(--primary);
    transition: all 0.3s;
  }

  .history-item:hover {
    background: rgba(255,255,255,0.1);
    transform: translateX(5px);
  }

  .history-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .history-amount {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary);
  }

  .history-status {
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .status-pending {
    background: rgba(255,215,0,0.1);
    color: var(--warning);
  }

  .status-approved {
    background: rgba(0,255,157,0.1);
    color: var(--success);
  }

  .status-rejected {
    background: rgba(255,71,87,0.1);
    color: var(--danger);
  }

  .history-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 15px;
  }

  .detail-label {
    font-size: 12px;
    color: var(--muted);
  }

  .detail-value {
    font-size: 14px;
    font-weight: 600;
  }

  .history-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--muted);
  }

  .no-history {
    text-align: center;
    padding: 50px 20px;
    color: var(--muted);
  }

  .no-history i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
  }

  /* ===== WALLET PAGE ===== */
  #walletPage .card {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
    margin: 15px;
  }

  #walletPage select, 
  #walletPage input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.1);
    color: white;
    margin-top: 5px;
    font-size: 14px;
  }

  #walletPage select:focus, 
  #walletPage input:focus {
    outline: none;
    border-color: var(--primary);
  }

  .withdraw-note {
    font-size: 12px;
    color: var(--warning);
    margin-top: 10px;
    text-align: center;
    width: 100%;
  }

  /* ===== LOADER ===== */
  .loader {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ===== VERIFICATION BADGE ===== */
  .verified-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: rgba(0,255,157,0.1);
    color: var(--success);
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
  }

  /* ===== NEW AD SYSTEM STYLES ===== */
  .ad-counter {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
  }

  .counter-text {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
    text-align: center;
  }

  .counter-progress {
    width: 100%;
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    overflow: hidden;
    margin: 5px 0;
  }

  .counter-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--secondary), var(--primary));
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  .boost-btn {
    background: linear-gradient(90deg, #00b09b, #96c93d) !important;
    color: white !important;
    animation: pulse 1.5s infinite;
  }

  .watch-btn {
    background: linear-gradient(90deg, var(--secondary), var(--primary)) !important;
    color: #000 !important;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 480px) {
    .nav {
      padding: 10px 0;
    }
    
    .nav-item {
      font-size: 0.65rem;
      padding: 5px 8px;
    }
    
    .nav-item i {
      font-size: 1.2rem;
    }
    
    .profile-pic {
      width: 80px;
      height: 80px;
    }
    
    .profile-action-grid {
      gap: 8px;
    }
    
    .profile-action-card span {
      font-size: 12px;
    }
    
    .stats-grid {
      grid-template-columns: 1fr;
    }
    
    .chart-wrapper {
      height: 200px;
    }
    
    .chart-scrollable {
      width: 1500px;
    }
    
    .rate-value {
      font-size: 28px;
    }
    
    .buy-btn {
      padding: 16px;
      font-size: 16px;
    }
    
    .history-tabs {
      gap: 5px;
    }
    
    .history-tab {
      padding: 8px 15px;
      font-size: 12px;
    }
  }
</style>
</head>

<body>
<div class="app">
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="profile">
      <img id="userImage" src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png">
      <div class="user-info">
        <span class="username" id="userName">Guest</span>
        <span class="status" id="userStatus">‚ö†Ô∏èUNVERIFY‚ö†Ô∏è</span>
      </div>
    </div>
    <div class="points">
      <img src="https://i.ibb.co.com/21h5fRF9/20251226-211304.png">
      <span id="totalCoin">0.0 foxio</span>
    </div>
  </div>

  <!-- ===== HOME PAGE ===== -->
  <div class="page active" id="homePage">
    <div class="balance-card">
      <h2>Total Coin</h2>
      <div class="balance" id="cryptoBalance">0.0 foxio</div>
    </div>
    
    <div class="section">
      <div class="asset">
        <div class="asset-left">
          <div class="icon btc"><img src="https://i.ibb.co.com/dJ0hDCPZ/bitcoin-icon-in-orange-colors-cryptocurrency-related-image-png.png"></div>
          Bitcoin
        </div>
        <div class="price" id="btcValue">$0</div>
      </div>
      <div class="asset">
        <div class="asset-left">
          <div class="icon eth"><img src="https://i.ibb.co.com/jkBVjX1H/images.png"></div>
          Ethereum
        </div>
        <div class="price" id="ethValue">$0</div>
      </div>
      <div class="asset">
        <div class="asset-left">
          <div class="icon ltc"><img src="https://i.ibb.co.com/nT081cP/pngtree-isolated-white-background-icon-of-litecoin-ltc-coin-vector-png-image-39196686.png"></div>
          Litecoin
        </div>
        <div class="price" id="ltcValue">$0</div>
      </div>
      <div class="asset">
        <div class="asset-left">
          <div class="icon foxio"><img src="https://i.ibb.co.com/21h5fRF9/20251226-211304.png"></div>
          Foxio
        </div>
        <div class="price" id="foxioPrice">$0.0015</div>
      </div>
    </div>
    
    <!-- Leaderboard Section -->
    <div class="home-leaderboard-section">
      <div class="home-leaderboard-header">
        <div class="home-leaderboard-title">
          <i class="fas fa-trophy"></i> Top 50 Leaderboard
        </div>
      </div>
      <div class="home-leaderboard-list" id="homeLeaderboardList">
        <div style="text-align:center; padding:15px; color:var(--muted);">
          <div class="loader" style="width:20px;height:20px;margin:0 auto 10px;"></div>
          <p style="font-size:12px;">Loading leaderboard...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== PLAY PAGE ===== -->
  <div class="page" id="playPage">
    <div class="play-page">
      <div class="play-container">
        <div class="play-icon">
          <i class="fas fa-gamepad"></i>
        </div>
        <h1 class="play-title">PLAY TO EARN</h1>
        <p class="play-subtitle">Get ready for the ultimate gaming experience!</p>
        <div class="coming-soon">COMING SOON</div>
      </div>
    </div>
  </div>

  <!-- ===== TAP PAGE ===== -->
  <div class="page" id="tapPage">
    <div class="mining-card">
      Today mining: <span id="todayclick">0</span> / <span id="reamingmining">5000</span>
    </div>
    
    <!-- Menu Buttons -->
    <div class="tg-webapp-top-pack">
      <div class="pack-items">
        <div class="lock-box" id="levelLockBox">
          <div class="chain left"></div>
          <div class="chain right"></div>
          <div class="lock">üîí</div>
          <button class="menu-btn" onclick="lockButton('levelLockBox')">
            <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Level">
            <span>Level</span>
          </button>
        </div>
        
        <div class="lock-box" id="playLockBox">
          <div class="chain left"></div>
          <div class="chain right"></div>
          <div class="lock">üîí</div>
          <button class="menu-btn" onclick="openPage('playPage')">
            <img src="https://i.postimg.cc/TPs3y14j/3224178.png" alt="Play">
            <span>Play</span>
          </button>
        </div>
        
        <div class="lock-box" id="buyLockBox">
          <div class="chain left"></div>
          <div class="chain right"></div>
          <div class="lock">üîí</div>
          <button class="menu-btn" onclick="openPage('buyPage')">
            <img src="https://i.postimg.cc/Z57Tg0ZM/4833311.png" alt="Buy">
            <span>Buy</span>
          </button>
        </div>
        
        <div class="lock-box" id="skinLockBox">
          <div class="chain left"></div>
          <div class="chain right"></div>
          <div class="lock">üîí</div>
          <button class="menu-btn" onclick="lockButton('skinLockBox')">
            <img src="https://cdn-icons-png.flaticon.com/512/892/892458.png" alt="Skin">
            <span>Skin</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Tap Zone -->
    <div class="tap-zone">
      <div class="tap-btn" id="tapBtn">
        <img src="https://i.ibb.co/Qvwp4wfG/20251225-101219.png" alt="Tap">
      </div>
      <button class="continue-btn" id="continueBtn">Do you want to continue mining?</button>
    </div>
    
    <!-- Energy Bar -->
    <div class="energy-container">
      <div class="energy-bar-container">
        <div class="energy-bar-fill" id="energyBar"></div>
      </div>
      <div class="energy-info">
        <span>Energy</span>
        <span id="energyText">100%</span>
      </div>
    </div>

    <!-- New AD System Dialog -->
    <div class="dialog" id="energyDialog">
      <div class="dialog-box">
        <h3>Energy Finished!</h3>
        <p>Watch ads to restore energy</p>
        
        <div class="ad-counter">
          <div class="counter-text" id="adCounterText">0/15</div>
          <div class="counter-progress">
            <div class="counter-progress-fill" id="adProgressBar"></div>
          </div>
          <div id="adStatusText" style="font-size:12px;color:var(--muted);margin-bottom:10px;">
            Watch ads based on your plan
          </div>
        </div>
        
        <button class="dialog-btn watch-btn" id="watchBtn">WATCH AD</button>
        <button class="dialog-btn boost-btn" id="boostBtn" style="display:none;">BOOST ENERGY</button>
        
        <div style="font-size:10px;color:var(--muted);margin-top:10px;">
          Plan: <span id="currentPlanText">Free</span> | Required: <span id="requiredAdsText">15</span> ads
        </div>
      </div>
    </div>

    <div class="dialog" id="limitDialog">
      <div class="dialog-box">
        <h3>Daily click limit reached</h3>
        <p>Come back tomorrow to continue mining</p>
        <button class="dialog-btn" id="limitOkBtn">OK</button>
      </div>
    </div>
  </div>

  <!-- ===== BUY PAGE (MARKET) ===== -->
  <div class="page" id="buyPage">
    <div class="buy-market-page">
      <div class="market-header">
        <h1 class="market-title">FOXIO MARKET</h1>
        <p class="market-subtitle">Premium Real-time Foxio Price Chart</p>
      </div>

      <!-- Current Rate -->
      <div class="foxio-rate-card">
        <div class="rate-display">
          <div class="rate-label">CURRENT PRICE</div>
          <div class="rate-value">
            <span id="currentFoxioPrice">$0.0015</span>
            <span class="rate-change up" id="priceChange">+0.00%</span>
          </div>
          <div style="font-size:12px;color:var(--muted);">
            Last updated: <span id="lastUpdated">Just now</span>
          </div>
        </div>

        <!-- Premium Chart -->
        <div class="premium-chart-container">
          <div class="chart-header">
            <div class="chart-title">FOXIO All Time Price Chart</div>
            <div class="chart-period">
              <button class="period-btn active" onclick="setChartPeriod(7)">7D</button>
              <button class="period-btn" onclick="setChartPeriod(30)">30D</button>
              <button class="period-btn" onclick="setChartPeriod(90)">90D</button>
              <button class="period-btn" onclick="setChartPeriod(365)">1Y</button>
              <button class="period-btn" onclick="setChartPeriod('all')">ALL</button>
            </div>
          </div>

          <div class="chart-wrapper" id="chartWrapper">
            <div class="chart-scrollable" id="chartScrollable">
              <canvas class="chart-canvas" id="priceChart"></canvas>
              <div class="current-price-line" id="currentPriceLine"></div>
            </div>
            <div class="time-indicator" id="timeIndicator">
              ‚Üê Touch & drag to view historical prices ‚Üí
            </div>
          </div>

          <div class="chart-footer">
            <div class="chart-stats">
              <div class="stat-item">
                <div class="chart-stat-value" id="chartHigh">$0.0015</div>
                <div class="chart-stat-label">24H High</div>
              </div>
              <div class="stat-item">
                <div class="chart-stat-value" id="chartLow">$0.0014</div>
                <div class="chart-stat-label">24H Low</div>
              </div>
              <div class="stat-item">
                <div class="chart-stat-value" id="chartVolume">1.2M</div>
                <div class="chart-stat-label">Volume</div>
              </div>
            </div>
            <div style="font-size:10px;color:var(--muted);">
              ‚Üê Scroll to explore historical data
            </div>
          </div>
        </div>

        <!-- Buy Now Section -->
        <div class="buy-now-section">
          <div class="buy-info">
            <div class="info-label">Min. Purchase</div>
            <div class="info-value" id="minPurchase">10 FOXIO</div>
          </div>
          <div class="buy-info">
            <div class="info-label">Service Fee</div>
            <div class="info-value">2%</div>
          </div>
          <button class="buy-btn" onclick="openBuyFormPage()">
            <i class="fas fa-shopping-cart"></i> BUY FOXIO NOW
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== BUY FORM PAGE ===== -->
  <div class="page" id="buyFormPage">
    <div class="buy-form-page">
      <div class="form-header">
        <h2>Buy Foxio Coins</h2>
        <p>Fill the form to purchase Foxio</p>
      </div>

      <div class="current-rate-box">
        <div class="current-rate-label">Current Foxio Rate</div>
        <div class="current-rate-value" id="buyPageRate">$0.0015 per coin</div>
      </div>

      <div class="buy-form">
        <!-- Coin Amount -->
        <div class="form-group">
          <label class="form-label">How many coins do you want to buy?</label>
          <div class="input-with-icon">
            <input type="number" class="form-input" id="buyAmount" placeholder="Enter coin amount" min="100" oninput="calculateBuyPrice()">
            <div class="input-icon">FOXIO</div>
          </div>
          <div style="font-size:12px;color:var(--muted);margin-top:5px;">
            Minimum purchase: <span id="minBuyAmount">100</span> FOXIO
          </div>
        </div>

        <!-- Calculation -->
        <div class="calculation-box">
          <div class="calc-row">
            <div class="calc-label">Coin Amount</div>
            <div class="calc-value" id="displayAmount">0 FOXIO</div>
          </div>
          <div class="calc-row">
            <div class="calc-label">Rate per coin</div>
            <div class="calc-value" id="displayRate">$0.0015</div>
          </div>
          <div class="calc-row">
            <div class="calc-label">Subtotal</div>
            <div class="calc-value" id="subtotal">$0.00</div>
          </div>
          <div class="calc-row">
            <div class="calc-label">Service Fee (2%)</div>
            <div class="calc-value" id="serviceFee">$0.00</div>
          </div>
          <div class="calc-row" style="border-top:2px solid rgba(255,255,255,0.1);padding-top:15px;margin-top:15px;">
            <div class="calc-label">TOTAL PAYABLE</div>
            <div class="calc-value calc-total" id="totalPayable">$0.00</div>
          </div>
        </div>

        <!-- Payment Method -->
        <div class="method-selection">
          <div class="method-title">Select Payment Method</div>
          <div class="method-grid" id="methodGrid">
            <!-- Methods will be loaded from Firebase -->
          </div>
        </div>

        <!-- Payment Info -->
        <div class="payment-info-box" id="paymentInfoBox" style="display:none;">
          <div class="payment-info-header">
            <i class="fas fa-info-circle"></i>
            <h4>Payment Instructions</h4>
          </div>
          <div class="payment-details">
            <div class="payment-number" id="paymentNumberText">01*********</div>
            <div class="payment-note" id="paymentNoteText">
              Send money to this number and enter transaction ID below
            </div>
          </div>
          <div class="copy-btn-container">
            <button class="copy-btn" onclick="copyPaymentNumber(this)" id="copyBtn">
              <i class="fas fa-copy"></i> Copy Number
            </button>
          </div>
        </div>

        <!-- Transaction Details -->
        <div class="form-group">
          <label class="form-label">Transaction ID</label>
          <input type="text" class="form-input" id="transactionId" placeholder="Enter transaction ID from payment">
        </div>

        <div class="form-group">
          <label class="form-label">Your Sender Number (Optional)</label>
          <input type="text" class="form-input" id="senderNumber" placeholder="Your payment number">
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button class="btn btn-back" onclick="openPage('buyPage')">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button class="btn btn-buy" onclick="submitBuyRequest()">
            <i class="fas fa-check-circle"></i> Confirm Purchase
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== HISTORY PAGE ===== -->
  <div class="page" id="historyPage">
    <div class="history-page">
      <div class="history-header">
        <h2><i class="fas fa-history"></i> All History</h2>
        <p>Your complete transaction history</p>
      </div>

      <div class="history-tabs" id="historyTabs">
        <div class="history-tab active" onclick="loadHistory('all')">All</div>
        <div class="history-tab" onclick="loadHistory('buy')">Buy</div>
        <div class="history-tab" onclick="loadHistory('withdraw')">Withdraw</div>
        <div class="history-tab" onclick="loadHistory('deposit')">Verify</div>
      </div>

      <div class="history-list" id="historyList">
        <div class="no-history" id="noHistory">
          <i class="fas fa-history"></i>
          <h3>No history yet</h3>
          <p>Your transaction history will appear here</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== WALLET PAGE ===== -->
  <div class="page" id="walletPage">
    <div class="profile-header">
      <h2>Wallet</h2>
      <p>Manage your withdrawals</p>
    </div>
    
    <div class="card">
      <span>Total Balance</span>
      <span id="walletBalance" style="font-size:24px;font-weight:700;color:var(--primary);">0.0 foxio</span>
    </div>
    
    <div class="card" style="flex-direction:column;align-items:flex-start;gap:10px;">
      <div style="width:100%;">
        <div class="form-group">
          <label>Withdraw Method</label>
          <select id="withdrawMethod" class="form-input">
            <option value="">Select Method</option>
            <option value="LTC">Litecoin (LTC)</option>
            <option value="UPI">UPI</option>
            <option value="BKASH">Bkash</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Amount (foxio)</label>
          <input type="number" id="withdrawAmount" class="form-input" placeholder="Enter Coin">
        </div>
        
        <div class="form-group">
          <label>Account Number</label>
          <input type="text" id="withdrawAccount" class="form-input" placeholder="Enter account number">
        </div>
        
        <div class="withdraw-note">
          ‚ö†Ô∏è Minimum Withdraw: 43 foxio ‚ö†Ô∏è
        </div>
        
        <button class="btn btn-primary" id="submitWithdraw" style="width:100%;margin-top:15px;">
          <i class="fas fa-paper-plane"></i> Submit Withdraw Request
        </button>
      </div>
    </div>
    
    <h3 style="margin:20px 20px 15px 20px;">Recent Withdraw History</h3>
    <div id="withdrawList" style="margin:0 20px;"></div>
  </div>

  <!-- ===== PROFILE PAGE ===== -->
  <div class="page" id="profilePage">
    <div class="profile-page">
      <div class="profile-header">
        <img class="profile-pic" id="profileImage" src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png">
        <div class="profile-name" id="profileName">Guest</div>
        <div class="profile-id" id="profileUserId">ID: Loading...</div>
        
        <div id="verificationStatus"></div>
      </div>
      
      <div class="profile-action-grid">
        <div class="profile-action-card" onclick="openPage('walletPage')">
          <i class="fas fa-wallet"></i>
          <span>Withdraw</span>
        </div>
        <div class="profile-action-card" onclick="openPage('plansPage')">
          <i class="fas fa-check-circle"></i>
          <span>Verify</span>
        </div>
        <div class="profile-action-card" onclick="openPage('historyPage')">
          <i class="fas fa-history"></i>
          <span>History</span>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="profileTotalCoin">0</div>
          <div class="stat-label">Total Coins</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="profileTotalTaps">0</div>
          <div class="stat-label">Total Taps</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="profileJoinedDays">0</div>
          <div class="stat-label">Days Active</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="profileWithdraws">0</div>
          <div class="stat-label">Withdraws</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== PLANS PAGE ===== -->
  <div class="page" id="plansPage">
    <div class="plans-page">
      <div class="profile-header">
        <h2>Upgrade Your Account</h2>
        <p>Choose a plan to unlock features</p>
      </div>
      
      <div class="plans-container">
        <!-- Free Plan (Current) -->
        <div class="plan-card" style="border-color: var(--muted);">
          <div class="plan-badge" style="background: var(--muted);">FREE</div>
          <div class="plan-title">Free Plan</div>
          <div class="plan-price" style="-webkit-text-fill-color: var(--muted);">Free</div>
          <ul class="plan-features">
            <li><i class="fas fa-check-circle"></i> Basic mining access</li>
            <li><i class="fas fa-check-circle"></i> 15 ads for energy boost</li>
            <li><i class="fas fa-check-circle"></i> Standard earning rate</li>
            <li><i class="fas fa-check-circle"></i> Withdraw limit: 0/month</li>
          </ul>
          <button class="btn btn-primary plan-btn" style="background: var(--muted);" disabled>
            <i class="fas fa-user"></i> Current Plan
          </button>
        </div>
        
        <!-- Basic Plan -->
        <div class="plan-card basic">
          <div class="plan-badge">BASIC</div>
          <div class="plan-title">Basic Plan</div>
          <div class="plan-price" id="basicPlanPrice">299 BDT</div>
          <ul class="plan-features">
            <li><i class="fas fa-check-circle"></i> Verification for 1 month</li>
            <li><i class="fas fa-check-circle"></i> 10 ads for energy boost</li>
            <li><i class="fas fa-check-circle"></i> Withdraw limit: 1/month</li>
            <li><i class="fas fa-check-circle"></i> Ad-free mining</li>
            <li><i class="fas fa-check-circle"></i> Normal earning rate</li>
          </ul>
          <button class="btn btn-primary plan-btn" onclick="selectPlan('basic')">
            <i class="fas fa-shopping-cart"></i> Buy Basic Plan
          </button>
        </div>
        
        <!-- Advance Plan -->
        <div class="plan-card advance">
          <div class="plan-badge">ADVANCE</div>
          <div class="plan-title">Advance Plan</div>
          <div class="plan-price" id="advancePlanPrice">599 BDT</div>
          <ul class="plan-features">
            <li><i class="fas fa-check-circle"></i> Verification for 2 months</li>
            <li><i class="fas fa-check-circle"></i> 7 ads for energy boost</li>
            <li><i class="fas fa-check-circle"></i> Withdraw limit: 5/month</li>
            <li><i class="fas fa-check-circle"></i> Priority support</li>
            <li><i class="fas fa-check-circle"></i> <strong>1.5x MORE COINS per tap!</strong></li>
          </ul>
          <button class="btn btn-success plan-btn" onclick="selectPlan('advance')">
            <i class="fas fa-crown"></i> Buy Advance Plan
          </button>
        </div>
        
        <!-- Premium Plan (NEW) -->
        <div class="plan-card premium">
          <div class="plan-badge premium">PREMIUM</div>
          <div class="plan-title">Premium Plan</div>
          <div class="plan-price" id="premiumPlanPrice" style="background: linear-gradient(90deg, #FFD700, #FFA500); -webkit-background-clip: text;">999 BDT</div>
          <ul class="plan-features">
            <li><i class="fas fa-check-circle"></i> Verification for 3 months</li>
            <li><i class="fas fa-check-circle"></i> Only 5 ads for energy boost</li>
            <li><i class="fas fa-check-circle"></i> Unlimited withdraws</li>
            <li><i class="fas fa-check-circle"></i> 24/7 priority support</li>
            <li><i class="fas fa-check-circle"></i> <strong>2x MORE COINS per tap!</strong></li>
            <li><i class="fas fa-check-circle"></i> Exclusive premium features</li>
          </ul>
          <button class="btn btn-success plan-btn" onclick="selectPlan('premium')" style="background: linear-gradient(90deg, #FFD700, #FFA500);">
            <i class="fas fa-gem"></i> Buy Premium Plan
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== DEPOSIT PAGE ===== -->
  <div class="page" id="depositPage">
    <div class="deposit-page">
      <div class="profile-header">
        <h2>Deposit Payment</h2>
        <p>Complete your payment to activate plan</p>
      </div>
      
      <div class="payment-info">
        <h4><i class="fas fa-info-circle"></i> Payment Instructions</h4>
        <p>Send money to this <span id="paymentMethodText">Nagad</span> number:</p>
        <div class="payment-details">
          <span style="font-weight:600;font-size:18px;" id="paymentNumber">01*********</span>
          <button class="copy-btn" onclick="copyToClipboardDeposit()" id="depositCopyBtn">
            <i class="fas fa-copy"></i> Copy
          </button>
        </div>
        <p style="font-size:12px;margin-top:10px;" id="paymentNote">(‡¶è‡¶á ‡¶®‡¶ó‡¶¶ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®)</p>
      </div>
      
      <div class="deposit-form">
        <div class="form-group">
          <label class="form-label">Selected Plan</label>
          <input type="text" id="selectedPlan" class="form-control" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">Amount (BDT)</label>
          <input type="number" id="depositAmount" class="form-control" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">Transaction ID</label>
          <input type="text" id="depositTransactionId" class="form-control" placeholder="Enter transaction ID">
        </div>
        
        <div class="form-group">
          <label class="form-label">Sender Number (Optional)</label>
          <input type="text" id="depositSenderNumber" class="form-control" placeholder="Your number">
        </div>
        
        <button class="btn btn-success" id="submitDeposit" style="width:100%;padding:15px;font-size:16px;">
          <i class="fas fa-paper-plane"></i> Submit Payment
        </button>
        
        <button class="btn" onclick="openPage('plansPage')" style="width:100%;margin-top:10px;background:#666;">
          <i class="fas fa-arrow-left"></i> Back to Plans
        </button>
      </div>
      
      <div class="history-list">
        <h3>Payment History</h3>
        <div id="depositHistory"></div>
      </div>
    </div>
  </div>

  <!-- ===== NAVIGATION ===== -->
  <div class="nav">
    <div class="nav-item active" onclick="openPage('homePage',this)">
      <i class="fas fa-home"></i>Home
    </div>
    <div class="nav-item" onclick="openPage('playPage',this)">
      <i class="fas fa-gamepad"></i>Play
    </div>
    <div class="nav-item" onclick="openPage('tapPage',this)">
      <i class="fas fa-hand-pointer"></i>Tap
    </div>
    <div class="nav-item" onclick="openPage('walletPage',this)">
      <i class="fas fa-wallet"></i>Wallet
    </div>
    <div class="nav-item" onclick="openPage('profilePage',this)">
      <i class="fas fa-user"></i>Profile
    </div>
  </div>
</div>

<!-- ===== TOAST ===== -->
<div class="toast" id="toastMsg"></div>

<!-- ===== JAVASCRIPT ===== -->
<script>
// ===== FIREBASE CONFIGURATION =====
const firebaseConfig = {
  apiKey: "AIzaSyA1Z_2B88vixL6ZGfDOIC-ZpEycIOr8iEI",
  authDomain: "tapfoxio-fd642.firebaseapp.com",
  databaseURL: "https://tapfoxio-fd642-default-rtdb.firebaseio.com",
  projectId: "tapfoxio-fd642",
  storageBucket: "tapfoxio-fd642.appspot.com",
  messagingSenderId: "336293918162",
  appId: "1:336293918162:web:3f37f3b24933045c50440b"
};

// Initialize Firebase
try {
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
} catch (e) {
  console.log("Firebase already initialized");
}

const database = firebase.database();

// ===== APP SETTINGS =====
let appSettings = {
  coinPerClick: 0.0003,
  dailyLimit: 5000,
  maxEnergyTaps: 100,
  foxioPrice: 0.0015,
  minWithdraw: 43,
  serviceFeePercent: 2,
  minBuyAmount: 100,
  
  // New Ad System Settings
  monetagEnabled: false,
  monetagZoneId: "",
  directLinkEnabled: true,
  directLinkUrl: "https://example.com",
  
  // Plan Settings
  basicPlanPrice: "299 BDT",
  advancePlanPrice: "599 BDT",
  premiumPlanPrice: "999 BDT",
  depositMethod: "Nagad",
  depositNumber: "01999999999",
  depositNote: "(‡¶è‡¶á ‡¶®‡¶ó‡¶¶ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®)"
};

// ===== TELEGRAM USER =====
let tg, username, userId, profilePic, firstName, lastName;

try {
  tg = window.Telegram.WebApp;
  if (tg) {
    tg.expand();
    tg.ready();
    username = tg.initDataUnsafe?.user?.username || "Guest";
    userId = tg.initDataUnsafe?.user?.id || Date.now().toString();
    profilePic = tg.initDataUnsafe?.user?.photo_url || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";
    firstName = tg.initDataUnsafe?.user?.first_name || "User";
    lastName = tg.initDataUnsafe?.user?.last_name || "";
  } else {
    username = "Guest";
    userId = Date.now().toString();
    profilePic = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";
    firstName = "User";
    lastName = "";
  }
} catch (e) {
  console.log("Telegram WebApp not available, using test mode");
  username = "Guest";
  userId = Date.now().toString();
  profilePic = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";
  firstName = "User";
  lastName = "";
}

// Set user info
document.getElementById("userName").innerText = firstName;
document.getElementById("userImage").src = profilePic;
document.getElementById("profileName").innerText = firstName + (lastName ? " " + lastName : "");
document.getElementById("profileImage").src = profilePic;
document.getElementById("profileUserId").innerText = `ID: ${userId}`;

// ===== USER & FIREBASE SETUP =====
const urlParams = new URLSearchParams(window.location.search);
const refUID = urlParams.get("start");
let UID = userId;
window.UID = UID;
window.userId = userId;
let userRef = database.ref("users/" + UID);
let currentUserCoin = 0;
let userData = {};

// Initialize user
userRef.once("value").then(snapshot => {
  if (!snapshot.exists() && username !== "Guest") {
    let initData = { 
      coin: 100, 
      username: username,
      firstName: firstName,
      lastName: lastName,
      userId: userId,
      profilePic: profilePic,
      totalTaps: 0,
      dailyTaps: 0,
      lastTapDate: new Date().toLocaleDateString(),
      accountStatus: "unverified",
      withdrawLimit: 0,
      planType: "free", // Default to free plan
      planExpiry: null,
      createdAt: Date.now(),
      isActive: true,
      lastActive: Date.now(),
      totalPurchased: 0,
      totalSpent: 0,
      // New AD System Data
      adsWatchedToday: 0,
      energyUsed: 0,
      lastAdWatchDate: new Date().toLocaleDateString()
    };
    
    if (refUID && refUID !== UID) {
      initData.invitedBy = refUID;
      
      let inviterRef = database.ref("users/" + refUID);
      inviterRef.transaction(current => {
        if (current === null) current = { coin: 100, totalReferrals: 0, referralEarnings: 0 };
        current.coin = (current.coin || 0) + 100;
        current.totalReferrals = (current.totalReferrals || 0) + 1;
        current.referralEarnings = (current.referralEarnings || 0) + 100;
        return current;
      });
    }
    
    userRef.set(initData);
  }
}).catch(error => {
  console.log("User initialization error:", error);
});

// ===== REAL-TIME USER DATA UPDATE =====
userRef.on("value", snapshot => {
  if (!snapshot.exists()) return;
  
  userData = snapshot.val();
  currentUserCoin = userData.coin || 0;
  
  // Update UI
  document.getElementById("totalCoin").innerText = formatfoxio(currentUserCoin);
  document.getElementById("walletBalance").innerText = formatfoxio(currentUserCoin);
  document.getElementById("cryptoBalance").innerText = formatfoxio(currentUserCoin);
  document.getElementById("profileTotalCoin").innerText = formatfoxio(currentUserCoin);
  document.getElementById("profileTotalTaps").innerText = userData.totalTaps || 0;
  
  // Update joined days
  if (userData.createdAt) {
    const joinDate = new Date(userData.createdAt);
    const today = new Date();
    const diffTime = Math.abs(today - joinDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    document.getElementById("profileJoinedDays").textContent = diffDays;
  }
  
  // Update account status
  updateAccountStatus();
}, error => {
  console.log("User data update error:", error);
});

// ===== FORMAT NUMBER =====
function formatfoxio(number) {
  const num = parseFloat(number);
  if (isNaN(num)) return "0.0 foxio";
  if (num % 1 === 0) return num + ".0 foxio";
  return num.toFixed(4) + " foxio";
}

// ===== UPDATE ACCOUNT STATUS =====
function updateAccountStatus() {
  const statusEl = document.getElementById("userStatus");
  const verificationStatusEl = document.getElementById("verificationStatus");
  
  if (userData.accountStatus === "verified") {
    statusEl.textContent = "‚úÖVERIFIED‚úÖ";
    statusEl.className = "status verified";
    
    verificationStatusEl.innerHTML = '<div class="verified-badge"><i class="fas fa-check-circle"></i> Verified Account</div>';
  } else {
    statusEl.textContent = "‚ö†Ô∏èUNVERIFY‚ö†Ô∏è";
    statusEl.className = "status";
    verificationStatusEl.innerHTML = "";
  }
}

// ===== LEADERBOARD LOADING =====
function loadHomeLeaderboard() {
  database.ref("users").once("value").then(snapshot => {
    if (!snapshot.exists()) {
      document.getElementById('homeLeaderboardList').innerHTML = `
        <div style="text-align:center; padding:15px; color:var(--muted);">
          <i class="fas fa-users"></i>
          <p style="font-size:12px;">No users found</p>
        </div>
      `;
      return;
    }
    
    const users = snapshot.val();
    let userList = [];
    
    // Convert to array
    for (const userId in users) {
      const user = users[userId];
      if (!user.coin && user.coin !== 0) continue;
      
      userList.push({
        id: userId,
        username: user.username || `User${userId.substring(0, 6)}`,
        firstName: user.firstName || "User",
        profilePic: user.profilePic || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png",
        coin: user.coin || 0,
        isCurrentUser: userId === window.UID
      });
    }
    
    // Sort by coin (highest first)
    userList.sort((a, b) => b.coin - a.coin);
    
    // Take top 50
    const topUsers = userList.slice(0, 50);
    
    const container = document.getElementById('homeLeaderboardList');
    container.innerHTML = '';
    
    if (topUsers.length === 0) {
      container.innerHTML = `
        <div style="text-align:center; padding:15px; color:var(--muted);">
          <i class="fas fa-users"></i>
          <p style="font-size:12px;">No users found</p>
        </div>
      `;
      return;
    }
    
    topUsers.forEach((user, index) => {
      const rank = index + 1;
      const leaderboardItem = document.createElement('div');
      leaderboardItem.className = 'home-leaderboard-item';
      
      // Determine rank class
      let rankClass = 'rank-other';
      if (rank === 1) rankClass = 'rank-1';
      else if (rank === 2) rankClass = 'rank-2';
      else if (rank === 3) rankClass = 'rank-3';
      
      leaderboardItem.innerHTML = `
        <div class="home-leaderboard-rank ${rankClass}">#${rank}</div>
        <div class="home-leaderboard-user">
          <img class="home-leaderboard-avatar" src="${user.profilePic}" alt="${user.firstName}" onerror="this.src='https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png'">
          <div class="home-leaderboard-name">${user.firstName}${user.isCurrentUser ? ' (You)' : ''}</div>
        </div>
        <div class="home-leaderboard-coins">${formatfoxio(user.coin)}</div>
      `;
      container.appendChild(leaderboardItem);
    });
  }).catch(error => {
    console.log("Leaderboard load error:", error);
  });
}

// ===== PREMIUM CHART SYSTEM =====
let allPriceHistory = [];
let currentChartData = [];
let chartPeriod = 7; // 7 days by default
let chartScrollPosition = 0;
let isDragging = false;
let startX = 0;
let scrollStart = 0;
let canvas = null;
let ctx = null;
let currentTooltip = null;

// Initialize price history
function initializePriceHistory() {
  const now = Date.now();
  const basePrice = appSettings.foxioPrice;
  allPriceHistory = [];
  
  // Generate 365 days of data (1 year)
  for (let i = 365; i >= 0; i--) {
    const date = new Date(now - (i * 24 * 60 * 60 * 1000));
    // Add realistic price variation
    let price = basePrice;
    if (i < 365) {
      const prevPrice = allPriceHistory[allPriceHistory.length - 1]?.price || basePrice;
      const change = (Math.random() - 0.5) * 0.0003;
      price = Math.max(0.0005, prevPrice + change);
    }
    
    // Add 4 points per day for smoother chart
    for (let hour = 0; hour < 24; hour += 6) {
      const hourDate = new Date(date.getTime() + (hour * 60 * 60 * 1000));
      const hourChange = (Math.random() - 0.5) * 0.0001;
      const hourPrice = Math.max(0.0005, price + hourChange);
      
      allPriceHistory.push({
        timestamp: hourDate.getTime(),
        price: hourPrice,
        date: hourDate.toLocaleDateString(),
        time: hourDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        volume: Math.random() * 1000000 + 500000
      });
    }
  }
  
  // Update current price
  const latestPrice = allPriceHistory[allPriceHistory.length - 1].price;
  appSettings.foxioPrice = latestPrice;
  
  // Initialize chart
  updateChartData();
  initChartCanvas();
}

function updateChartData() {
  const now = Date.now();
  let filteredData = [];
  
  if (chartPeriod === 'all') {
    filteredData = [...allPriceHistory];
  } else {
    const periodMs = chartPeriod * 24 * 60 * 60 * 1000;
    const cutoffTime = now - periodMs;
    filteredData = allPriceHistory.filter(point => point.timestamp >= cutoffTime);
  }
  
  // If we have too many points, sample them
  if (filteredData.length > 500) {
    const step = Math.ceil(filteredData.length / 500);
    currentChartData = filteredData.filter((_, index) => index % step === 0);
  } else {
    currentChartData = filteredData;
  }
  
  // Update chart stats
  updateChartStats();
  drawChart();
}

function updateChartStats() {
  if (currentChartData.length === 0) return;
  
  const prices = currentChartData.map(d => d.price);
  const high = Math.max(...prices);
  const low = Math.min(...prices);
  const current = currentChartData[currentChartData.length - 1].price;
  const first = currentChartData[0].price;
  const change = ((current - first) / first) * 100;
  const totalVolume = currentChartData.reduce((sum, d) => sum + d.volume, 0);
  
  document.getElementById('chartHigh').textContent = '$' + high.toFixed(4);
  document.getElementById('chartLow').textContent = '$' + low.toFixed(4);
  document.getElementById('chartVolume').textContent = (totalVolume / 1000000).toFixed(1) + 'M';
  
  // Update main price display
  document.getElementById('currentFoxioPrice').textContent = '$' + current.toFixed(4);
  document.getElementById('foxioPrice').textContent = '$' + current.toFixed(4);
  document.getElementById('buyPageRate').textContent = '$' + current.toFixed(4) + ' per coin';
  document.getElementById('displayRate').textContent = '$' + current.toFixed(4);
  
  const changeElement = document.getElementById('priceChange');
  changeElement.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
  changeElement.className = 'rate-change ' + (change >= 0 ? 'up' : 'down');
  
  // Update last updated time
  const lastDate = new Date(currentChartData[currentChartData.length - 1].timestamp);
  document.getElementById('lastUpdated').textContent = 
    lastDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function initChartCanvas() {
  canvas = document.getElementById('priceChart');
  if (!canvas) return;
  
  const wrapper = document.getElementById('chartWrapper');
  const scrollable = document.getElementById('chartScrollable');
  
  // Set canvas size
  canvas.width = 2000;
  canvas.height = wrapper.clientHeight;
  canvas.style.width = '2000px';
  canvas.style.height = wrapper.clientHeight + 'px';
  
  ctx = canvas.getContext('2d');
  
  // Setup touch/scroll events
  setupChartInteractions();
  
  // Initial draw
  drawChart();
  updateChartPosition();
}

function setupChartInteractions() {
  const scrollable = document.getElementById('chartScrollable');
  const wrapper = document.getElementById('chartWrapper');
  
  // Mouse/touch events for dragging
  scrollable.addEventListener('mousedown', startDrag);
  scrollable.addEventListener('touchstart', startDragTouch);
  
  wrapper.addEventListener('mousemove', drag);
  wrapper.addEventListener('touchmove', dragTouch);
  
  wrapper.addEventListener('mouseup', endDrag);
  wrapper.addEventListener('touchend', endDrag);
  wrapper.addEventListener('touchcancel', endDrag);
  
  // Mouse move for tooltips
  scrollable.addEventListener('mousemove', showTooltip);
  scrollable.addEventListener('mouseleave', hideTooltip);
  
  // Touch for tooltips
  scrollable.addEventListener('touchmove', showTooltipTouch);
  scrollable.addEventListener('touchend', hideTooltip);
}

function startDrag(e) {
  isDragging = true;
  startX = e.clientX;
  scrollStart = chartScrollPosition;
  e.preventDefault();
}

function startDragTouch(e) {
  if (e.touches.length === 1) {
    isDragging = true;
    startX = e.touches[0].clientX;
    scrollStart = chartScrollPosition;
    e.preventDefault();
  }
}

function drag(e) {
  if (!isDragging) return;
  e.preventDefault();
  
  const deltaX = e.clientX - startX;
  const maxScroll = canvas.width - document.getElementById('chartWrapper').clientWidth;
  chartScrollPosition = Math.max(0, Math.min(maxScroll, scrollStart - deltaX * 2));
  updateChartPosition();
}

function dragTouch(e) {
  if (!isDragging || e.touches.length !== 1) return;
  e.preventDefault();
  
  const deltaX = e.touches[0].clientX - startX;
  const maxScroll = canvas.width - document.getElementById('chartWrapper').clientWidth;
  chartScrollPosition = Math.max(0, Math.min(maxScroll, scrollStart - deltaX * 2));
  updateChartPosition();
}

function endDrag() {
  isDragging = false;
}

function updateChartPosition() {
  const scrollable = document.getElementById('chartScrollable');
  scrollable.style.transform = `translateX(-${chartScrollPosition}px)`;
  
  // Update time indicator
  updateTimeIndicator();
}

function updateTimeIndicator() {
  const indicator = document.getElementById('timeIndicator');
  if (!indicator || currentChartData.length === 0) return;
  
  const visibleWidth = document.getElementById('chartWrapper').clientWidth;
  const totalWidth = canvas.width;
  const percent = chartScrollPosition / (totalWidth - visibleWidth);
  
  if (percent < 0.1) {
    indicator.innerHTML = '‚Üê Current prices';
  } else if (percent > 0.9) {
    indicator.innerHTML = 'Historical prices ‚Üí';
  } else {
    const visiblePoints = Math.ceil((visibleWidth / totalWidth) * currentChartData.length);
    const startIndex = Math.floor((chartScrollPosition / totalWidth) * currentChartData.length);
    const endIndex = Math.min(startIndex + visiblePoints, currentChartData.length - 1);
    
    const startDate = new Date(currentChartData[startIndex].timestamp);
    const endDate = new Date(currentChartData[endIndex].timestamp);
    
    if (chartPeriod === 'all' || chartPeriod >= 30) {
      indicator.innerHTML = 
        `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}<br>` +
        '<span style="font-size:10px;">‚Üê Touch & drag to explore ‚Üí</span>';
    } else {
      indicator.innerHTML = 
        `${startDate.toLocaleDateString()}<br>` +
        '<span style="font-size:10px;">‚Üê Touch & drag to explore ‚Üí</span>';
    }
  }
}

function showTooltip(e) {
  if (isDragging || currentChartData.length === 0) return;
  
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left + chartScrollPosition;
  const y = e.clientY - rect.top;
  
  // Find nearest data point
  const pointWidth = canvas.width / currentChartData.length;
  const dataIndex = Math.floor(x / pointWidth);
  
  if (dataIndex >= 0 && dataIndex < currentChartData.length) {
    const point = currentChartData[dataIndex];
    const pointX = dataIndex * pointWidth - chartScrollPosition;
    const pointY = getYPosition(point.price);
    
    // Remove existing tooltip
    hideTooltip();
    
    // Create new tooltip
    currentTooltip = document.createElement('div');
    currentTooltip.className = 'price-tooltip';
    currentTooltip.innerHTML = `
      <div class="tooltip-date">${point.date} ${point.time}</div>
      <div class="tooltip-price">$${point.price.toFixed(4)}</div>
    `;
    
    // Position tooltip
    const tooltipX = Math.min(rect.left + pointX, window.innerWidth - 150);
    const tooltipY = rect.top + pointY - 60;
    
    currentTooltip.style.left = tooltipX + 'px';
    currentTooltip.style.top = tooltipY + 'px';
    
    document.body.appendChild(currentTooltip);
    
    // Draw point highlight
    drawPointHighlight(pointX + chartScrollPosition, pointY);
  }
}

function showTooltipTouch(e) {
  if (isDragging || currentChartData.length === 0 || e.touches.length !== 1) return;
  
  const rect = canvas.getBoundingClientRect();
  const x = e.touches[0].clientX - rect.left + chartScrollPosition;
  
  // Find nearest data point
  const pointWidth = canvas.width / currentChartData.length;
  const dataIndex = Math.floor(x / pointWidth);
  
  if (dataIndex >= 0 && dataIndex < currentChartData.length) {
    const point = currentChartData[dataIndex];
    const pointX = dataIndex * pointWidth - chartScrollPosition;
    const pointY = getYPosition(point.price);
    
    // Remove existing tooltip
    hideTooltip();
    
    // Create new tooltip
    currentTooltip = document.createElement('div');
    currentTooltip.className = 'price-tooltip';
    currentTooltip.innerHTML = `
      <div class="tooltip-date">${point.date} ${point.time}</div>
      <div class="tooltip-price">$${point.price.toFixed(4)}</div>
    `;
    
    // Position tooltip
    const tooltipX = Math.min(rect.left + pointX, window.innerWidth - 150);
    const tooltipY = rect.top + pointY - 60;
    
    currentTooltip.style.left = tooltipX + 'px';
    currentTooltip.style.top = tooltipY + 'px';
    
    document.body.appendChild(currentTooltip);
    
    // Draw point highlight
    drawPointHighlight(pointX + chartScrollPosition, pointY);
  }
}

function hideTooltip() {
  if (currentTooltip) {
    currentTooltip.remove();
    currentTooltip = null;
    drawChart(); // Redraw without highlight
  }
}

function drawPointHighlight(x, y) {
  drawChart(); // Redraw base chart
  
  // Draw highlight point
  ctx.beginPath();
  ctx.arc(x, y, 6, 0, Math.PI * 2);
  ctx.fillStyle = '#FFFFFF';
  ctx.fill();
  ctx.strokeStyle = '#00f2ff';
  ctx.lineWidth = 2;
  ctx.stroke();
  
  // Draw connecting line
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x, canvas.height);
  ctx.strokeStyle = 'rgba(0, 242, 255, 0.3)';
  ctx.lineWidth = 1;
  ctx.setLineDash([5, 3]);
  ctx.stroke();
  ctx.setLineDash([]);
}

function getYPosition(price) {
  const prices = currentChartData.map(d => d.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const priceRange = maxPrice - minPrice;
  
  if (priceRange === 0) return canvas.height / 2;
  
  const normalizedPrice = (price - minPrice) / priceRange;
  return canvas.height - (normalizedPrice * (canvas.height - 40)) - 20;
}

function drawChart() {
  if (!ctx || currentChartData.length === 0) return;
  
  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Get price range
  const prices = currentChartData.map(d => d.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const priceRange = maxPrice - minPrice;
  
  // Draw grid
  drawGrid();
  
  // Draw chart line
  ctx.beginPath();
  ctx.lineWidth = 2;
  
  // Determine line color based on trend
  const firstPrice = currentChartData[0].price;
  const lastPrice = currentChartData[currentChartData.length - 1].price;
  const isUp = lastPrice >= firstPrice;
  
  ctx.strokeStyle = isUp ? '#00ff9d' : '#ff4757';
  
  // Draw line
  currentChartData.forEach((point, index) => {
    const x = (index / (currentChartData.length - 1)) * canvas.width;
    const y = getYPosition(point.price);
    
    if (index === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  
  ctx.stroke();
  
  // Draw gradient fill
  const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
  if (isUp) {
    gradient.addColorStop(0, 'rgba(0, 255, 157, 0.1)');
    gradient.addColorStop(1, 'rgba(0, 255, 157, 0)');
  } else {
    gradient.addColorStop(0, 'rgba(255, 71, 87, 0.1)');
    gradient.addColorStop(1, 'rgba(255, 71, 87, 0)');
  }
  
  ctx.lineTo(canvas.width, canvas.height);
  ctx.lineTo(0, canvas.height);
  ctx.closePath();
  ctx.fillStyle = gradient;
  ctx.fill();
  
  // Draw price labels on the side
  drawPriceLabels(minPrice, maxPrice);
}

function drawGrid() {
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
  ctx.lineWidth = 1;
  
  // Horizontal lines
  const horizontalLines = 4;
  for (let i = 0; i <= horizontalLines; i++) {
    const y = (i / horizontalLines) * (canvas.height - 40) + 20;
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
    
    // Draw price labels
    const price = minPrice + (i / horizontalLines) * (maxPrice - minPrice);
    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
    ctx.font = '10px Poppins';
    ctx.textAlign = 'right';
    ctx.fillText('$' + price.toFixed(4), 50, y + 3);
  }
  
  // Vertical lines (fewer for performance)
  const verticalLines = Math.min(currentChartData.length, 20);
  for (let i = 0; i <= verticalLines; i++) {
    const x = (i / verticalLines) * canvas.width;
    ctx.beginPath();
    ctx.moveTo(x, 20);
    ctx.lineTo(x, canvas.height - 20);
    ctx.stroke();
  }
}

function drawPriceLabels(minPrice, maxPrice) {
  // Already drawn in drawGrid function
}

function setChartPeriod(period) {
  // Update button states
  document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  chartPeriod = period;
  updateChartData();
  
  // Reset scroll position
  chartScrollPosition = 0;
  updateChartPosition();
}

// ===== LOAD APP SETTINGS =====
function loadAppSettings() {
  database.ref("appSettings").on("value", snapshot => {
    if (snapshot.exists()) {
      const settings = snapshot.val();
      
      // Basic settings
      appSettings.coinPerClick = settings.coinPerClick || 0.0003;
      appSettings.dailyLimit = settings.dailyLimit || 5000;
      appSettings.maxEnergyTaps = settings.maxEnergyTaps || 100;
      appSettings.foxioPrice = parseFloat(settings.foxioPrice?.replace('$', '') || 0.0015);
      appSettings.minWithdraw = settings.minWithdraw || 43;
      appSettings.serviceFeePercent = settings.serviceFeePercent || 2;
      appSettings.minBuyAmount = settings.minBuyAmount || 100;
      
      // New AD System Settings
      appSettings.monetagEnabled = settings.monetagEnabled || false;
      appSettings.monetagZoneId = settings.monetagZoneId || "";
      appSettings.directLinkEnabled = settings.directLinkEnabled || true;
      appSettings.directLinkUrl = settings.directLinkUrl || "https://example.com";
      
      // Plan Settings
      appSettings.basicPlanPrice = settings.basicPlanPrice || "299 BDT";
      appSettings.advancePlanPrice = settings.advancePlanPrice || "599 BDT";
      appSettings.premiumPlanPrice = settings.premiumPlanPrice || "999 BDT";
      appSettings.depositMethod = settings.depositMethod || "Nagad";
      appSettings.depositNumber = settings.depositNumber || "01996532373";
      appSettings.depositNote = settings.depositNote || "(‡¶è‡¶á ‡¶®‡¶ó‡¶¶ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®)";
      
      // Update UI
      const price = appSettings.foxioPrice.toFixed(4);
      document.getElementById('foxioPrice').textContent = '$' + price;
      document.getElementById('currentFoxioPrice').textContent = '$' + price;
      document.getElementById('buyPageRate').textContent = '$' + price + ' per coin';
      document.getElementById('displayRate').textContent = '$' + price;
      document.getElementById('minPurchase').textContent = appSettings.minBuyAmount + ' FOXIO';
      document.getElementById('minBuyAmount').textContent = appSettings.minBuyAmount;
      
      // Load BUY METHODS from Firebase
      loadBuyMethodsFromFirebase();
      
      // Update plan prices
      document.getElementById('basicPlanPrice').textContent = appSettings.basicPlanPrice;
      document.getElementById('advancePlanPrice').textContent = appSettings.advancePlanPrice;
      document.getElementById('premiumPlanPrice').textContent = appSettings.premiumPlanPrice;
      document.getElementById('paymentMethodText').textContent = appSettings.depositMethod;
      document.getElementById('paymentNumber').textContent = appSettings.depositNumber;
      document.getElementById('paymentNote').textContent = appSettings.depositNote;
      
      // Initialize price history with current price
      initializePriceHistory();
    }
  }, error => {
    console.log("Settings load error:", error);
    initializePriceHistory();
  });
}

// ===== LOAD BUY METHODS FROM FIREBASE =====
let activeBuyMethods = [];
let selectedMethod = null;

function loadBuyMethodsFromFirebase() {
  database.ref('buyMethods').on('value', snapshot => {
    const methods = snapshot.val() || {};
    activeBuyMethods = [];
    
    // ‡¶∂‡ßÅ‡¶ß‡ßÅ Active methods ‡¶®‡¶ø‡¶®
    for (const methodId in methods) {
      const method = methods[methodId];
      if (method.active !== false) { // ‡¶∂‡ßÅ‡¶ß‡ßÅ active methods
        method.id = methodId;
        method.rate = method.rate || appSettings.foxioPrice;
        activeBuyMethods.push(method);
      }
    }
    
    // UI update
    const methodGrid = document.getElementById('methodGrid');
    methodGrid.innerHTML = '';
    
    if (activeBuyMethods.length === 0) {
      methodGrid.innerHTML = `
        <div style="grid-column: span 2; text-align: center; padding: 30px; color: var(--muted);">
          <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p>No payment methods available</p>
          <p style="font-size: 12px;">Contact system to add payment methods</p>
        </div>
      `;
      document.getElementById('paymentInfoBox').style.display = 'none';
      return;
    }
    
    activeBuyMethods.forEach(method => {
      const methodOption = document.createElement('div');
      methodOption.className = 'method-option';
      methodOption.onclick = () => selectPaymentMethod(method.id);
      
      let icon = 'fas fa-money-bill-wave';
      if (method.type === 'crypto') icon = 'fas fa-coins';
      if (method.type === 'bank_account') icon = 'fas fa-university';
      if (method.type === 'mobile_banking') icon = 'fas fa-mobile-alt';
      if (method.type === 'other') icon = 'fas fa-wallet';
      
      methodOption.innerHTML = `
        <div class="method-icon">
          <i class="${icon}"></i>
        </div>
        <div class="method-name">${method.name}</div>
        <div class="method-fee">Rate: ${method.rate} BDT/foxio</div>
      `;
      
      methodGrid.appendChild(methodOption);
    });
    
    // Select first method by default
    if (activeBuyMethods.length > 0) {
      setTimeout(() => selectPaymentMethod(activeBuyMethods[0].id), 100);
    }
  }, error => {
    console.log("Buy methods load error:", error);
  });
}

// ===== SELECT PAYMENT METHOD =====
function selectPaymentMethod(methodId) {
  selectedMethod = activeBuyMethods.find(m => m.id === methodId);
  if (!selectedMethod) return;
  
  // Update UI
  document.querySelectorAll('.method-option').forEach(opt => opt.classList.remove('active'));
  document.querySelectorAll('.method-option').forEach(opt => {
    const nameDiv = opt.querySelector('.method-name');
    if (nameDiv && nameDiv.textContent === selectedMethod.name) {
      opt.classList.add('active');
    }
  });
  
  // Show payment info
  document.getElementById('paymentInfoBox').style.display = 'block';
  document.getElementById('paymentNumberText').textContent = selectedMethod.number || 'Not available';
  document.getElementById('paymentNoteText').textContent = selectedMethod.instructions || 'Send money and provide transaction ID';
  
  // Reset copy button
  const copyBtn = document.getElementById('copyBtn');
  copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Number';
  copyBtn.className = 'copy-btn';
  
  // Recalculate price
  calculateBuyPrice();
}

// ===== COPY PAYMENT NUMBER =====
function copyPaymentNumber(button) {
  if (!selectedMethod || !selectedMethod.number) {
    showToast("No payment number available");
    return;
  }
  
  const textToCopy = selectedMethod.number;
  
  // Try using modern clipboard API first
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(textToCopy)
      .then(() => {
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.className = 'copy-btn copied';
        showToast("Payment number copied to clipboard!");
        
        // Reset button after 2 seconds
        setTimeout(() => {
          button.innerHTML = '<i class="fas fa-copy"></i> Copy Number';
          button.className = 'copy-btn';
        }, 2000);
      })
      .catch(err => {
        console.error('Clipboard write failed:', err);
        fallbackCopyText(textToCopy, button);
      });
  } else {
    // Fallback for older browsers
    fallbackCopyText(textToCopy, button);
  }
}

// Fallback copy method
function fallbackCopyText(text, button) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  
  // Make the textarea out of viewport
  textArea.style.position = "fixed";
  textArea.style.left = "-999999px";
  textArea.style.top = "-999999px";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      button.innerHTML = '<i class="fas fa-check"></i> Copied!';
      button.className = 'copy-btn copied';
      showToast("Payment number copied to clipboard!");
      
      setTimeout(() => {
        button.innerHTML = '<i class="fas fa-copy"></i> Copy Number';
        button.className = 'copy-btn';
      }, 2000);
    } else {
      showToast("Failed to copy. Please copy manually: " + text);
    }
  } catch (err) {
    console.error('Fallback copy failed:', err);
    showToast("Failed to copy. Please copy manually: " + text);
  }
  
  document.body.removeChild(textArea);
}

// ===== COPY DEPOSIT NUMBER =====
function copyToClipboardDeposit() {
  const textToCopy = appSettings.depositNumber;
  const button = document.getElementById('depositCopyBtn');
  
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(textToCopy)
      .then(() => {
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.className = 'copy-btn copied';
        showToast("Deposit number copied to clipboard!");
        
        setTimeout(() => {
          button.innerHTML = '<i class="fas fa-copy"></i> Copy';
          button.className = 'copy-btn';
        }, 2000);
      })
      .catch(err => {
        console.error('Clipboard write failed:', err);
        fallbackCopyText(textToCopy, button);
      });
  } else {
    fallbackCopyText(textToCopy, button);
  }
}

// ===== CALCULATE BUY PRICE =====
function calculateBuyPrice() {
  const amount = parseFloat(document.getElementById('buyAmount').value) || 0;
  const minAmount = appSettings.minBuyAmount || 100;
  
  if (amount < minAmount) {
    document.getElementById('buyAmount').value = minAmount;
    return;
  }
  
  const rate = selectedMethod ? parseFloat(selectedMethod.rate) : appSettings.foxioPrice;
  const feePercent = appSettings.serviceFeePercent;
  
  const subtotal = amount * rate;
  const fee = (subtotal * feePercent) / 100;
  const total = subtotal + fee;
  
  document.getElementById('displayAmount').textContent = amount.toLocaleString() + ' FOXIO';
  document.getElementById('displayRate').textContent = rate.toFixed(4) + ' BDT';
  document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' BDT';
  document.getElementById('serviceFee').textContent = fee.toFixed(2) + ' BDT';
  document.getElementById('totalPayable').textContent = total.toFixed(2) + ' BDT';
}

// ===== SUBMIT BUY REQUEST =====
function submitBuyRequest() {
  const amount = parseFloat(document.getElementById('buyAmount').value);
  const transactionId = document.getElementById('transactionId').value.trim();
  const senderNumber = document.getElementById('senderNumber').value.trim();
  
  const minAmount = appSettings.minBuyAmount || 100;
  if (!amount || amount < minAmount) {
    showToast(`Minimum purchase: ${minAmount} FOXIO`);
    return;
  }
  
  if (!selectedMethod) {
    showToast('Please select a payment method');
    return;
  }
  
  if (!transactionId) {
    showToast('Please enter transaction ID');
    return;
  }
  
  if (transactionId.length < 8) {
    showToast('Please enter a valid transaction ID (min 8 characters)');
    return;
  }
  
  const rate = parseFloat(selectedMethod.rate);
  const feePercent = appSettings.serviceFeePercent;
  const subtotal = amount * rate;
  const fee = (subtotal * feePercent) / 100;
  const total = subtotal + fee;
  
  const buyRef = database.ref('buyRequests').push();
  const buyData = {
    userId: UID,
    username: username,
    firstName: firstName,
    lastName: lastName,
    coinAmount: amount,
    rate: rate,
    subtotal: subtotal,
    fee: fee,
    total: total,
    methodName: selectedMethod.name,
    methodId: selectedMethod.id,
    paymentNumber: selectedMethod.number,
    transactionId: transactionId,
    senderNumber: senderNumber || 'Not provided',
    status: 'pending',
    timestamp: Date.now(),
    processedAt: null,
    processedBy: null
  };
  
  buyRef.set(buyData)
    .then(() => {
      showToast('‚úÖ Purchase request submitted! System will review it.');
      
      // Reset form
      document.getElementById('buyAmount').value = '';
      document.getElementById('transactionId').value = '';
      document.getElementById('senderNumber').value = '';
      
      // Update user's total purchased
      userRef.child('totalPurchased').transaction(current => {
        return (current || 0) + amount;
      });
      
      userRef.child('totalSpent').transaction(current => {
        return (current || 0) + total;
      });
      
      // Go to history page
      openPage('historyPage');
    })
    .catch(error => {
      showToast('‚ùå Error: ' + error.message);
    });
}

// ===== LOAD ALL HISTORY =====
function loadHistory(type = 'all') {
  const historyList = document.getElementById('historyList');
  const noHistory = document.getElementById('noHistory');
  
  // Show loading
  historyList.innerHTML = `
    <div style="text-align:center; padding:40px;">
      <div class="loader" style="width:30px;height:30px;margin:0 auto 15px;"></div>
      <p>Loading history...</p>
    </div>
  `;
  
  // Update tabs
  document.querySelectorAll('.history-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.history-tab').forEach(tab => {
    if (tab.textContent.toLowerCase().includes(type)) {
      tab.classList.add('active');
    }
  });
  
  // Combine all histories
  Promise.all([
    loadBuyHistoryData(),
    loadWithdrawHistoryData(),
    loadDepositHistoryData()
  ]).then(([buyHistory, withdrawHistory, depositHistory]) => {
    let allHistory = [];
    
    // Add type to each item
    buyHistory.forEach(item => {
      item.type = 'buy';
      item.timestamp = item.timestamp || Date.now();
    });
    
    withdrawHistory.forEach(item => {
      item.type = 'withdraw';
      item.timestamp = item.timestamp || Date.now();
    });
    
    depositHistory.forEach(item => {
      item.type = 'deposit';
      item.timestamp = item.timestamp || Date.now();
    });
    
    // Combine based on type
    if (type === 'all') {
      allHistory = [...buyHistory, ...withdrawHistory, ...depositHistory];
    } else if (type === 'buy') {
      allHistory = buyHistory;
    } else if (type === 'withdraw') {
      allHistory = withdrawHistory;
    } else if (type === 'deposit') {
      allHistory = depositHistory;
    }
    
    // Sort by timestamp (newest first)
    allHistory.sort((a, b) => b.timestamp - a.timestamp);
    
    // Display history
    displayHistory(allHistory, type);
  }).catch(error => {
    console.log("History load error:", error);
    historyList.innerHTML = `
      <div class="no-history">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Error loading history</h3>
        <p>Please try again later</p>
      </div>
    `;
  });
}

function loadBuyHistoryData() {
  return new Promise((resolve) => {
    database.ref('buyRequests').orderByChild('userId').equalTo(UID).once('value')
      .then(snapshot => {
        const requests = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            requests.push({id: child.key, ...child.val()});
          });
        }
        resolve(requests);
      })
      .catch(() => resolve([]));
  });
}

function loadWithdrawHistoryData() {
  return new Promise((resolve) => {
    database.ref('withdraws/' + UID).once('value')
      .then(snapshot => {
        const requests = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            requests.push({id: child.key, ...child.val()});
          });
        }
        resolve(requests);
      })
      .catch(() => resolve([]));
  });
}

function loadDepositHistoryData() {
  return new Promise((resolve) => {
    database.ref('deposits').orderByChild('userId').equalTo(UID).once('value')
      .then(snapshot => {
        const requests = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            requests.push({id: child.key, ...child.val()});
          });
        }
        resolve(requests);
      })
      .catch(() => resolve([]));
  });
}

function displayHistory(history, type) {
  const historyList = document.getElementById('historyList');
  
  if (history.length === 0) {
    historyList.innerHTML = `
      <div class="no-history">
        <i class="fas fa-${type === 'buy' ? 'shopping-cart' : type === 'withdraw' ? 'money-bill-wave' : 'check-circle'}"></i>
        <h3>No ${type} history found</h3>
        <p>Your ${type} history will appear here</p>
      </div>
    `;
    return;
  }
  
  historyList.innerHTML = '';
  
  history.forEach(item => {
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item';
    
    // Format date
    const date = new Date(item.timestamp);
    const formattedDate = date.toLocaleDateString();
    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Determine icon and title based on type
    let icon = 'fas fa-history';
    let title = 'Transaction';
    let amountText = '';
    let status = item.status || 'pending';
    
    if (item.type === 'buy') {
      icon = 'fas fa-shopping-cart';
      title = 'Foxio Purchase';
      amountText = `${item.coinAmount || 0} FOXIO`;
    } else if (item.type === 'withdraw') {
      icon = 'fas fa-money-bill-wave';
      title = 'Withdraw Request';
      amountText = `${item.amount || 0} FOXIO`;
    } else if (item.type === 'deposit') {
      icon = 'fas fa-check-circle';
      title = 'Verification Payment';
      amountText = `${item.amount || 0} BDT`;
    }
    
    // Determine status class
    let statusClass = 'status-pending';
    let statusText = status.charAt(0).toUpperCase() + status.slice(1);
    
    if (status === 'approved' || status === 'success') {
      statusClass = 'status-approved';
      statusText = 'Approved';
    } else if (status === 'rejected') {
      statusClass = 'status-rejected';
      statusText = 'Rejected';
    }
    
    historyItem.innerHTML = `
      <div class="history-item-header">
        <div class="history-amount">${amountText}</div>
        <div class="history-status ${statusClass}">${statusText}</div>
      </div>
      <div class="history-details">
        <div>
          <div class="detail-label">Type</div>
          <div class="detail-value">${title}</div>
        </div>
        <div>
          <div class="detail-label">Date</div>
          <div class="detail-value">${formattedDate}</div>
        </div>
        <div>
          <div class="detail-label">Time</div>
          <div class="detail-value">${formattedTime}</div>
        </div>
        <div>
          <div class="detail-label">Status</div>
          <div class="detail-value">${statusText}</div>
        </div>
      </div>
      <div class="history-footer">
        <div><i class="${icon}"></i> ${title}</div>
        <div>${item.transactionId ? item.transactionId.substring(0, 8) + '...' : 'No ID'}</div>
      </div>
    `;
    
    historyList.appendChild(historyItem);
  });
}

// ===== PAGE NAVIGATION =====
function openPage(pageId, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if(el) el.classList.add('active');
  
  // Page-specific actions
  if (pageId === 'buyPage') {
    // Initialize or redraw chart
    setTimeout(() => {
      if (!canvas) {
        initializePriceHistory();
      } else {
        drawChart();
        updateChartPosition();
      }
    }, 100);
  }
  if (pageId === 'homePage') {
    loadHomeLeaderboard();
  }
  if (pageId === 'historyPage') {
    loadHistory('all');
  }
  if (pageId === 'profilePage') {
    loadDepositHistory();
  }
  if (pageId === 'tapPage') {
    // Update AD counter when opening tap page
    updateAdCounterUI();
  }
}

function openBuyFormPage() {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('buyFormPage').classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  
  // Initialize form
  if (selectedMethod) {
    calculateBuyPrice();
  } else if (activeBuyMethods.length > 0) {
    selectPaymentMethod(activeBuyMethods[0].id);
    setTimeout(() => calculateBuyPrice(), 100);
  }
}

// ===== TOAST MESSAGE =====
function showToast(msg) {
  const t = document.getElementById("toastMsg");
  t.innerText = msg;
  t.style.display = "block";
  setTimeout(() => {
    t.style.display = "none";
  }, 3000);
}

// ===== LOCK BUTTON =====
function lockButton(buttonId) {
  const lockBox = document.getElementById(buttonId);
  if (!lockBox.classList.contains('locked')) {
    lockBox.classList.add('locked');
    showToast('Coming Soon!');
  }
}

// ===== NEW PLAN SYSTEM & AD LOGIC =====
let todayClick = 0;
let energyUsed = 0;
let remainingClick = appSettings.dailyLimit;
let clickCount = 0;
let isWatchingAd = false;
let isAdAvailable = true;
let adsWatchedToday = 0;
let countdownTimer = null;
let countdownSeconds = 15;

const tapBtn = document.getElementById("tapBtn");
const continueBtn = document.getElementById("continueBtn");
const energyBar = document.getElementById("energyBar");
const energyText = document.getElementById("energyText");
const todayclickEl = document.getElementById("todayclick");
const reamingminingEl = document.getElementById("reamingmining");
const dialog = document.getElementById("energyDialog");
const watchBtn = document.getElementById("watchBtn");
const boostBtn = document.getElementById("boostBtn");
const adCounterText = document.getElementById("adCounterText");
const adProgressBar = document.getElementById("adProgressBar");
const adStatusText = document.getElementById("adStatusText");
const currentPlanText = document.getElementById("currentPlanText");
const requiredAdsText = document.getElementById("requiredAdsText");
const limitDialog = document.getElementById("limitDialog");
const limitOkBtn = document.getElementById("limitOkBtn");

// Get required ads based on plan
function getRequiredAds() {
  const planType = userData.planType || 'free';
  switch(planType) {
    case 'premium': return 5;
    case 'advance': return 7;
    case 'basic': return 10;
    default: return 15; // free plan
  }
}

// Get plan name for display
function getPlanName() {
  const planType = userData.planType || 'free';
  switch(planType) {
    case 'premium': return 'Premium';
    case 'advance': return 'Advance';
    case 'basic': return 'Basic';
    default: return 'Free';
  }
}

// Update AD counter UI
function updateAdCounterUI() {
  const requiredAds = getRequiredAds();
  const currentPlan = getPlanName();
  const watchedAds = userData.adsWatchedToday || 0;
  
  adCounterText.textContent = `${watchedAds}/${requiredAds}`;
  adProgressBar.style.width = `${(watchedAds / requiredAds) * 100}%`;
  adStatusText.textContent = watchedAds >= requiredAds 
    ? 'Ready to boost energy!' 
    : `Watch ${requiredAds - watchedAds} more ads`;
  currentPlanText.textContent = currentPlan;
  requiredAdsText.textContent = requiredAds;
  
  // Show/hide buttons based on watched ads
  if (watchedAds >= requiredAds) {
    watchBtn.style.display = 'none';
    boostBtn.style.display = 'block';
  } else {
    watchBtn.style.display = 'block';
    boostBtn.style.display = 'none';
  }
}

function loadUserTapData() {
  userRef.once("value").then(snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      const today = new Date().toLocaleDateString();
      const lastTapDate = data.lastTapDate || today;
      
      if (lastTapDate !== today) {
        todayClick = 0;
        energyUsed = 0;
        adsWatchedToday = 0;
        
        userRef.update({
          dailyTaps: 0,
          lastTapDate: today,
          energyUsed: 0,
          adsWatchedToday: 0,
          lastAdWatchDate: today
        });
      } else {
        todayClick = data.dailyTaps || 0;
        energyUsed = data.energyUsed || 0;
        adsWatchedToday = data.adsWatchedToday || 0;
      }
      
      remainingClick = appSettings.dailyLimit - todayClick;
      updateEnergy();
      updateMiningStatus();
      updateAdCounterUI();
    }
  }).catch(error => {
    console.log("Tap data load error:", error);
  });
}

function updateEnergy() {
  const energyPercent = Math.max(0, 100 - (energyUsed / appSettings.maxEnergyTaps) * 100);
  energyBar.style.width = energyPercent + "%";
  energyText.innerText = energyPercent.toFixed(1) + "%";
}

function updateMiningStatus() {
  todayclickEl.innerText = todayClick;
  reamingminingEl.innerText = remainingClick;
}

function saveTapDataToFirebase() {
  const tapData = {
    dailyTaps: todayClick,
    totalTaps: firebase.database.ServerValue.increment(1),
    energyUsed: energyUsed,
    adsWatchedToday: adsWatchedToday,
    lastTapDate: new Date().toLocaleDateString(),
    lastTapTime: Date.now(),
    lastAdWatchDate: new Date().toLocaleDateString()
  };
  
  userRef.update(tapData).catch(error => {
    console.log("Save tap data error:", error);
  });
}

function addCoinToUser() {
  let coinPerClick = appSettings.coinPerClick;
  let coinMultiplier = 1.0;
  
  const planType = userData.planType || 'free';
  if (planType === 'premium') {
    coinMultiplier = 2.0;
  } else if (planType === 'advance') {
    coinMultiplier = 1.5;
  } else if (planType === 'basic') {
    coinMultiplier = 1.0;
  } else {
    coinMultiplier = 1.0;
  }
  
  const earnedCoins = coinPerClick * coinMultiplier;
  
  userRef.child("coin").transaction(current => {
    if (current === null) current = 0;
    return parseFloat((current + earnedCoins).toFixed(10));
  }).catch(error => {
    console.log("Add coin error:", error);
  });
  
  return earnedCoins;
}

// ===== NEW DUAL AD SYSTEM =====
function loadMonetagAd() {
  if (!appSettings.monetagEnabled || !appSettings.monetagZoneId) {
    console.log("Monetag ad system not configured");
    return false;
  }
  
  // Check if monetag script already loaded
  if (window.monetag) {
    return true;
  }
  
  // Load monetag script
  const script = document.createElement('script');
  script.src = 'https://lib.monetag.com/static/js/monetag.js';
  script.async = true;
  script.onload = function() {
    console.log('Monetag script loaded');
  };
  script.onerror = function() {
    console.error('Failed to load Monetag script');
  };
  document.head.appendChild(script);
  
  return true;
}

function showMonetagAd() {
  if (!appSettings.monetagEnabled || !window.monetag) {
    console.log("Monetag not available");
    return false;
  }
  
  try {
    // Call monetag API to show ad
    monetag.cmd.push(function() {
      monetag.uni.user({
        id: UID
      }).ad({
        zone: appSettings.monetagZoneId,
        format: 'full',
        onStart: function() {
          console.log('Monetag ad started');
        },
        onComplete: function() {
          console.log('Monetag ad completed');
          // Ad completed successfully
          handleAdCompleted();
        },
        onError: function(error) {
          console.error('Monetag ad error:', error);
          showToast("Ad failed to load. Try again.");
          isWatchingAd = false;
        }
      });
    });
    return true;
  } catch (error) {
    console.error('Monetag ad error:', error);
    return false;
  }
}

function showDirectLinkAd() {
  if (!appSettings.directLinkEnabled || !appSettings.directLinkUrl) {
    console.log("Direct link ad not configured");
    return false;
  }
  
  // Open link in WebView
  if (tg && tg.openLink) {
    tg.openLink(appSettings.directLinkUrl);
  } else {
    // Fallback for non-telegram
    window.open(appSettings.directLinkUrl, '_blank');
  }
  
  // Simulate ad completion after 5 seconds
  setTimeout(() => {
    handleAdCompleted();
  }, 5000);
  
  return true;
}

function handleAdCompleted() {
  // Increment watched ads
  adsWatchedToday++;
  userRef.update({ 
    adsWatchedToday: adsWatchedToday,
    lastAdWatchDate: new Date().toLocaleDateString()
  }).catch(() => {});
  
  // Update UI
  updateAdCounterUI();
  isWatchingAd = false;
  
  const requiredAds = getRequiredAds();
  if (adsWatchedToday < requiredAds) {
    showToast(`Ad watched! Watch ${requiredAds - adsWatchedToday} more ads to boost energy.`);
  } else {
    showToast("You've watched enough ads! Click BOOST to restore energy.");
  }
}

// Tap button click event
let isTapping = false;
if (tapBtn) {
  tapBtn.addEventListener("click", (e) => {
    if (isTapping) return;
    isTapping = true;
    
    if (todayClick >= appSettings.dailyLimit) {
      limitDialog.style.display = "flex";
      isTapping = false;
      return;
    }
    
    // Check if user has energy
    if (energyUsed >= appSettings.maxEnergyTaps) {
      dialog.style.display = "flex";
      isTapping = false;
      return;
    }
    
    tapBtn.classList.remove("tap-animate");
    void tapBtn.offsetWidth;
    tapBtn.classList.add("tap-animate");
    
    const earnedCoins = addCoinToUser();
    const planType = userData.planType || 'free';
    const isPremiumPlan = planType === 'premium';
    const isAdvancePlan = planType === 'advance';
    
    const rect = tapBtn.getBoundingClientRect();
    const toast = document.createElement("div");
    toast.className = "tap-toast";
    toast.innerText = `+${earnedCoins.toFixed(6)}${isPremiumPlan ? ' üíé' : isAdvancePlan ? ' ü¶ä' : ''}`;
    toast.style.left = (e.clientX - rect.left) + "px";
    toast.style.top = (e.clientY - rect.top) + "px";
    tapBtn.appendChild(toast);
    setTimeout(() => toast.remove(), 800);
    
    energyUsed = Math.min(energyUsed + 1, appSettings.maxEnergyTaps);
    updateEnergy();
    
    todayClick++;
    remainingClick = appSettings.dailyLimit - todayClick;
    
    saveTapDataToFirebase();
    
    updateMiningStatus();
    
    clickCount++;
    if (clickCount >= 25) {
      tapBtn.style.display = "none";
      continueBtn.style.display = "block";
    }
    
    setTimeout(() => {
      isTapping = false;
    }, 100);
  });
}

// Watch ad button
if (watchBtn) {
  watchBtn.addEventListener("click", function() {
    if (isWatchingAd) return;
    
    isWatchingAd = true;
    watchBtn.disabled = true;
    watchBtn.innerHTML = '<span class="loader"></span> Loading Ad...';
    
    // Determine which ad system to use
    let adShown = false;
    
    if (appSettings.monetagEnabled && appSettings.monetagZoneId) {
      if (loadMonetagAd()) {
        setTimeout(() => {
          adShown = showMonetagAd();
          if (!adShown) {
            // Fallback to direct link
            showDirectLinkAd();
          }
        }, 1000);
      } else {
        showDirectLinkAd();
        adShown = true;
      }
    } else if (appSettings.directLinkEnabled) {
      showDirectLinkAd();
      adShown = true;
    }
    
    if (!adShown) {
      showToast("No ad system available. Try again later.");
      watchBtn.disabled = false;
      watchBtn.innerHTML = 'WATCH AD';
      isWatchingAd = false;
    }
  });
}

// Boost button
if (boostBtn) {
  boostBtn.addEventListener("click", function() {
    const requiredAds = getRequiredAds();
    if (adsWatchedToday < requiredAds) {
      showToast(`Watch ${requiredAds - adsWatchedToday} more ads first!`);
      return;
    }
    
    // Reset energy and ads
    energyUsed = 0;
    adsWatchedToday = 0;
    
    userRef.update({ 
      energyUsed: 0,
      adsWatchedToday: 0 
    }).catch(() => {});
    
    // Update UI
    updateEnergy();
    updateAdCounterUI();
    
    // Close dialog
    dialog.style.display = "none";
    
    showToast("Energy restored! Continue mining!");
  });
}

// Continue mining button action
if (continueBtn) {
  continueBtn.addEventListener("click", function() {
    if (isTapping || isWatchingAd) return;
    isTapping = true;
    isWatchingAd = true;
    
    continueBtn.disabled = true;
    continueBtn.innerHTML = '<span class="loader"></span> Loading Ad...';
    
    // Show ad
    let adShown = false;
    
    if (appSettings.monetagEnabled && appSettings.monetagZoneId) {
      if (loadMonetagAd()) {
        setTimeout(() => {
          adShown = showMonetagAd();
          if (!adShown) {
            showDirectLinkAd();
          }
        }, 1000);
      } else {
        showDirectLinkAd();
        adShown = true;
      }
    } else if (appSettings.directLinkEnabled) {
      showDirectLinkAd();
      adShown = true;
    }
    
    if (adShown) {
      setTimeout(() => {
        continueBtn.style.display = "none";
        tapBtn.style.display = "flex";
        clickCount = 0;
        continueBtn.disabled = false;
        continueBtn.innerHTML = "Do you want to continue mining?";
        showToast("Continue mining!");
        isTapping = false;
        isWatchingAd = false;
      }, 5000);
    } else {
      showToast("No ad system available. Continue mining anyway.");
      setTimeout(() => {
        continueBtn.style.display = "none";
        tapBtn.style.display = "flex";
        clickCount = 0;
        continueBtn.disabled = false;
        continueBtn.innerHTML = "Do you want to continue mining?";
        isTapping = false;
        isWatchingAd = false;
      }, 1000);
    }
  });
}

// Limit OK button
if (limitOkBtn) {
  limitOkBtn.addEventListener("click", () => {
    limitDialog.style.display = "none";
  });
}

// ===== WITHDRAW LOGIC =====
document.getElementById("submitWithdraw").addEventListener("click", () => {
  const method = document.getElementById("withdrawMethod").value;
  const amount = parseFloat(document.getElementById("withdrawAmount").value);
  const account = document.getElementById("withdrawAccount").value.trim();
  
  if (!method || amount < appSettings.minWithdraw || !account) {
    showToast(`Fill all fields, minimum withdraw ${appSettings.minWithdraw} foxio`);
    return;
  }
  
  if (userData.accountStatus !== "verified") {
    showToast("‚ö†Ô∏è You must be verified to withdraw!");
    return;
  }
  
  if (amount > currentUserCoin) {
    showToast("Insufficient foxio");
    return;
  }
  
  const withdrawRef = database.ref("withdraws/" + UID);
  const newWithdraw = withdrawRef.push();
  
  newWithdraw.set({
    method: method,
    amount: amount,
    account: account,
    status: "pending",
    timestamp: Date.now(),
    username: username,
    userId: UID
  }).then(() => {
    // Deduct coins from user
    userRef.child("coin").transaction(current => {
      if (current === null) current = 0;
      return Math.max(0, current - amount);
    }).catch(() => {});
    
    showToast("Withdraw request sent!");
    document.getElementById("withdrawAmount").value = "";
    document.getElementById("withdrawAccount").value = "";
  }).catch(error => {
    showToast("Error: " + error.message);
  });
});

// ===== LOAD CRYPTO PRICES =====
async function loadPrices() {
  try {
    const response = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,litecoin&vs_currencies=usd");
    const data = await response.json();
    
    if (data.bitcoin) {
      document.getElementById("btcValue").innerText = "$" + (0.002 * data.bitcoin.usd).toFixed(2);
    }
    if (data.ethereum) {
      document.getElementById("ethValue").innerText = "$" + (0.01 * data.ethereum.usd).toFixed(2);
    }
    if (data.litecoin) {
      document.getElementById("ltcValue").innerText = "$" + (0.05 * data.litecoin.usd).toFixed(2);
    }
  } catch (e) {
    console.error("Failed to load prices", e);
    // Fallback prices
    document.getElementById("btcValue").innerText = "$60.12";
    document.getElementById("ethValue").innerText = "$30.45";
    document.getElementById("ltcValue").innerText = "$3.25";
  }
}

// ===== LOAD WITHDRAW HISTORY =====
const withdrawRef = database.ref("withdraws/" + UID);
withdrawRef.on("value", snapshot => {
  const listDiv = document.getElementById("withdrawList");
  listDiv.innerHTML = "";
  
  if (!snapshot.exists()) {
    listDiv.innerHTML = '<div class="card" style="text-align:center;color:var(--muted);">No withdraw history</div>';
    return;
  }
  
  let withdraws = [];
  snapshot.forEach(child => {
    let w = child.val();
    w.id = child.key;
    withdraws.push(w);
  });
  
  withdraws.sort((a, b) => b.timestamp - a.timestamp);
  
  // Show only last 5
  const recentWithdraws = withdraws.slice(0, 5);
  
  document.getElementById("profileWithdraws").textContent = withdraws.length;
  
  recentWithdraws.forEach(w => {
    const item = document.createElement("div");
    item.className = "history-item";
    
    let statusClass = "status-pending";
    if (w.status && w.status.toLowerCase() === "success") statusClass = "status-approved";
    else if (w.status && w.status.toLowerCase() === "rejected") statusClass = "status-rejected";
    
    const date = new Date(w.timestamp).toLocaleDateString();
    
    item.innerHTML = `
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
        <span style="font-weight:600;">${w.method || 'N/A'}</span>
        <span class="history-status ${statusClass}">${w.status || 'pending'}</span>
      </div>
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
        <span>Amount: ${w.amount || 0} foxio</span>
        <span>${date}</span>
      </div>
      <div style="font-size:12px;color:var(--muted);">Account: ${w.account || 'N/A'}</div>
    `;
    listDiv.appendChild(item);
  });
}, error => {
  console.log("Withdraw history load error:", error);
});

// ===== PLAN SELECTION =====
let selectedPlan = null;

function selectPlan(planType) {
  selectedPlan = planType;
  
  if (planType === 'basic') {
    document.getElementById('selectedPlan').value = 'Basic Plan';
    document.getElementById('depositAmount').value = '299';
  } else if (planType === 'advance') {
    document.getElementById('selectedPlan').value = 'Advance Plan';
    document.getElementById('depositAmount').value = '599';
  } else if (planType === 'premium') {
    document.getElementById('selectedPlan').value = 'Premium Plan';
    document.getElementById('depositAmount').value = '999';
  }
  
  openPage('depositPage');
}

// ===== SUBMIT DEPOSIT =====
document.getElementById('submitDeposit').addEventListener('click', function() {
  const plan = document.getElementById('selectedPlan').value;
  const amount = document.getElementById('depositAmount').value;
  const transactionId = document.getElementById('depositTransactionId').value.trim();
  const senderNumber = document.getElementById('depositSenderNumber').value.trim();
  
  if (!plan || !amount || !transactionId) {
    showToast('Please fill all required fields');
    return;
  }
  
  if (transactionId.length < 8) {
    showToast('Please enter a valid transaction ID');
    return;
  }
  
  this.disabled = true;
  this.innerHTML = '<span class="loader"></span> Processing...';
  
  const depositRef = database.ref('deposits').push();
  
  const planData = {
    planType: selectedPlan,
    amount: amount,
    transactionId: transactionId,
    senderNumber: senderNumber || 'Not provided',
    username: username,
    userId: UID,
    status: 'pending',
    timestamp: Date.now(),
    userFirstName: firstName,
    userLastName: lastName || '',
    depositMethod: appSettings.depositMethod,
    depositNumber: appSettings.depositNumber
  };
  
  depositRef.set(planData)
    .then(() => {
      showToast('Deposit request submitted! System will review it.');
      document.getElementById('depositTransactionId').value = '';
      document.getElementById('depositSenderNumber').value = '';
      this.disabled = false;
      this.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Payment';
      openPage('profilePage');
    })
    .catch(error => {
      showToast('Error submitting request: ' + error.message);
      this.disabled = false;
      this.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Payment';
    });
});

// ===== LOAD DEPOSIT HISTORY =====
function loadDepositHistory() {
  const depositHistoryRef = database.ref('deposits').orderByChild('userId').equalTo(UID);
  
  depositHistoryRef.once('value').then(snapshot => {
    const historyDiv = document.getElementById('depositHistory');
    historyDiv.innerHTML = '';
    
    if (!snapshot.exists()) {
      historyDiv.innerHTML = '<div class="card" style="text-align:center;color:var(--muted);">No deposit history</div>';
      return;
    }
    
    let deposits = [];
    snapshot.forEach(child => {
      let d = child.val();
      d.id = child.key;
      deposits.push(d);
    });
    
    deposits.sort((a, b) => b.timestamp - a.timestamp);
    
    deposits.forEach(d => {
      const item = document.createElement("div");
      item.className = "history-item";
      
      let statusClass = "status-pending";
      if (d.status === 'approved') statusClass = "status-approved";
      else if (d.status === 'rejected') statusClass = "status-rejected";
      
      const date = new Date(d.timestamp).toLocaleDateString();
      const time = new Date(d.timestamp).toLocaleTimeString();
      
      item.innerHTML = `
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span style="font-weight:600;">${d.planType} Plan</span>
          <span class="history-status ${statusClass}">${d.status || 'pending'}</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span>Amount: ${d.amount} BDT</span>
          <span>${date}</span>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:5px;">
          Transaction ID: ${d.transactionId || 'N/A'}
        </div>
        <div style="font-size:11px;color:var(--muted);">
          Submitted: ${time}
        </div>
      `;
      historyDiv.appendChild(item);
    });
  }).catch(error => {
    console.log("Deposit history load error:", error);
  });
}

// ===== INITIALIZE =====
window.onload = function() {
  loadAppSettings();
  loadUserTapData();
  loadPrices();
  loadHomeLeaderboard();
  
  // Auto-save function
  setInterval(() => {
    if (todayClick > 0) {
      saveTapDataToFirebase();
    }
  }, 30000);
  
  // Simulate live price updates
  setInterval(() => {
    if (allPriceHistory.length > 0) {
      // Add new price point
      const lastPoint = allPriceHistory[allPriceHistory.length - 1];
      const newPrice = Math.max(0.0005, lastPoint.price + (Math.random() - 0.5) * 0.00005);
      const newTimestamp = Date.now();
      
      allPriceHistory.push({
        timestamp: newTimestamp,
        price: newPrice,
        date: new Date(newTimestamp).toLocaleDateString(),
        time: new Date(newTimestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        volume: Math.random() * 1000000 + 500000
      });
      
      // Keep only last 365 days of data
      const oneYearAgo = Date.now() - (365 * 24 * 60 * 60 * 1000);
      allPriceHistory = allPriceHistory.filter(point => point.timestamp >= oneYearAgo);
      
      // Update chart
      updateChartData();
      
      // Auto-scroll to latest if at the end
      const wrapper = document.getElementById('chartWrapper');
      if (wrapper && canvas && chartScrollPosition > canvas.width - wrapper.clientWidth - 100) {
        chartScrollPosition = Math.max(0, canvas.width - wrapper.clientWidth);
        updateChartPosition();
      }
    }
  }, 10000); // Update every 10 seconds
};

// Handle window resize
window.addEventListener('resize', () => {
  if (canvas) {
    const wrapper = document.getElementById('chartWrapper');
    
    canvas.height = wrapper.clientHeight;
    canvas.style.height = wrapper.clientHeight + 'px';
    
    drawChart();
    updateChartPosition();
  }
});
</script>
</body>
</html>